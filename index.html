<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIMULASI CBT CAKIM PA</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --light: #ecf0f1;
            --filled: #95a5a6;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --pass: #2ecc71;
            --fail: #e74c3c;
            --google: #DB4437;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('ma.jpeg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            display: flex;
            height: 100vh;
            color: #333;
            overflow: hidden;
            transition: all 0.3s;
        }

        /* --- LOGIN SCREEN --- */
        .login-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(5px);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 350px;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }

        .btn-google {
            width: 100%; padding: 12px; 
            background: white; color: #333; 
            border: 2px solid #ddd; border-radius: 6px; 
            font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.2s;
        }
        .btn-google:hover { background: #f1f1f1; border-color: #ccc; }

        .login-footer { margin-top: 20px; font-size: 0.75rem; color: #888; border-top: 1px solid #eee; padding-top: 10px; }

        /* --- APP CONTAINER --- */
        #appSection {
            display: none;
            width: 100%;
            height: 100%;
            display: flex;
        }

        /* --- SIDEBAR KIRI (MODUL) --- */
        .sidebar-left {
            width: 280px;
            background-color: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
            z-index: 10;
            transition: margin-left 0.3s ease;
        }

        /* MODE FOKUS DESKTOP (Sidebar Kiri Ngumpet) */
        body.mode-focus .sidebar-left { margin-left: -280px; }
        body.mode-focus #floatingTimer { display: block !important; }

        .sidebar-header {
            padding: 20px;
            background-color: var(--primary);
            color: white;
            text-align: center;
        }

        .user-profile {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 10px; font-size: 0.9rem;
        }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; }

        /* TIMER DI SIDEBAR (MUNCUL DI DESKTOP) */
        .timer-container {
            background: rgba(0,0,0,0.2);
            padding: 10px; margin-top: 15px; border-radius: 5px;
            font-size: 1.5rem; font-weight: bold; color: #ffeb3b; 
            border: 2px solid rgba(255,255,255,0.1); transition: all 0.3s ease; 
            display: block; 
        }
        
        .timer-green { background-color: #27ae60 !important; color: white !important; border-color: #2ecc71 !important; }
        .timer-yellow { background-color: #f39c12 !important; color: black !important; border-color: #f1c40f !important; }
        .timer-panic { background-color: #c0392b !important; color: white !important; border-color: #e74c3c !important; animation: panicPulse 0.5s infinite alternate; }
        @keyframes panicPulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.05); opacity: 0.8; } }

        .modul-selector {
            flex: 1; padding: 10px; background: #f8f9fa; overflow-y: auto;
        }

        .modul-btn {
            display: block; width: 100%; padding: 12px 15px; margin-bottom: 8px;
            background: white; border: 1px solid #ddd; border-radius: 6px;
            cursor: pointer; text-align: left; font-size: 0.9rem; font-weight: 600;
            color: var(--secondary); transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .modul-btn:hover { background: var(--light); transform: translateX(2px); }
        .modul-btn.active-modul { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; padding: 20px 40px;
            overflow-y: auto; background: #f4f7f6; transition: all 0.3s ease;
        }

        .card {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); max-width: 900px;
            margin: 0 auto; width: 100%; margin-bottom: 50px;
        }

        /* --- SIDEBAR KANAN --- */
        .sidebar-right {
            width: 300px; background-color: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; height: 100vh;
            flex-shrink: 0; z-index: 10;
        }

        .right-header {
            padding: 15px; border-bottom: 1px solid #eee; display: flex;
            justify-content: space-between; background: #fff; gap: 5px; flex-wrap: wrap;
        }

        .btn-small {
            border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer;
            font-size: 0.75rem; font-weight: bold; display: flex; align-items: center;
            gap: 5px; transition: 0.2s; color: white; flex: 1; justify-content: center;
        }
        .btn-logout { background: var(--danger); }
        .btn-stats { background: var(--accent); }
        .btn-rank { background: #f39c12; }
        .btn-small:hover { opacity: 0.9; }

        .sidebar-info {
            padding: 15px; font-size: 0.8rem; text-align: center;
            background: #f9f9f9; border-bottom: 1px solid #eee;
        }

        .nav-container {
            flex: 1; overflow-y: auto; padding: 15px; background: white;
        }

        .nav-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
        }

        .nav-btn {
            aspect-ratio: 1; border: 1px solid #ddd; background: white; cursor: pointer;
            border-radius: 6px; font-weight: bold; display: flex; align-items: center;
            justify-content: center; font-size: 0.9rem; color: #555; transition: all 0.2s;
        }
        .nav-btn:hover { background-color: var(--light); }
        .nav-btn.active { border: 2px solid var(--accent); box-shadow: 0 0 8px rgba(41, 128, 185, 0.4); transform: scale(1.1); z-index: 2; color: var(--accent); }
        .nav-btn.filled { background-color: var(--secondary); color: white; border-color: var(--secondary); }
        .nav-btn.correct { background-color: var(--success); color: white; border-color: var(--success); }
        .nav-btn.wrong { background-color: var(--danger); color: white; border-color: var(--danger); }
        .nav-btn.ragu { background-color: #f1c40f !important; color: black !important; border-color: #f39c12 !important; }

        .finish-container {
            padding: 20px; border-top: 1px solid #eee; background: #f9f9f9;
        }

        /* --- QUESTION STYLES --- */
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--light); padding-bottom: 15px; }
        .question-text { font-size: 1.2rem; margin-bottom: 30px; line-height: 1.6; font-weight: 500; color: #2c3e50; }
        
        .option-label {
            display: flex; align-items: center; padding: 15px; border: 2px solid #eee;
            border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1rem;
            background: white; margin-bottom: 10px;
        }
        .option-label:hover { background-color: #f8f9fa; border-color: var(--accent); }
        .option-label.selected { background-color: #eaf6ff; border-color: var(--accent); }
        .option-label.review-correct { background-color: #d4edda; border-color: var(--success); color: #155724; }
        .option-label.review-wrong { background-color: #f8d7da; border-color: var(--danger); color: #721c24; }

        .btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; color: white; transition: 0.3s; }
        .btn-prev { background-color: var(--secondary); }
        .btn-next { background-color: var(--accent); }
        .btn-finish { background-color: var(--success); width: 100%; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .feedback-box { margin-top: 25px; padding: 20px; border-radius: 8px; background-color: #fff3cd; border-left: 5px solid #f39c12; display: none; }
        .feedback-box.show { display: block; }

        .watermark {
            position: fixed; left: 0; bottom: 0; width: 100%;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px);
            border-top: 1px solid rgba(255,255,255,0.5); text-align: center; padding: 12px 0;
            color: #2c3e50; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 10;
        }

        /* --- POPUPS (Z-INDEX SUPER TINGGI 20000) --- */
        .result-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.85); display: none; 
            justify-content: center; align-items: center; 
            z-index: 20000 !important; 
            backdrop-filter: blur(5px); 
        }
        
        .result-box { 
            background: white; padding: 20px; border-radius: 15px; text-align: center; 
            width: 800px; max-width: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            max-height: 95vh; overflow-y: auto; animation: slideUp 0.5s ease-out; 
        }
        
        .score-circle { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); color: white; display: flex; justify-content: center;  align-items: center; font-size: 2.5rem; font-weight: bold; margin: 20px auto; border: 5px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        .stats-table th { background-color: var(--primary); color: white; }
        .stats-table tr:nth-child(even) { background-color: #f9f9f9; }
        .stats-section-title { text-align: left; margin: 15px 0 5px 0; font-weight: bold; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .footer-nav { margin-top: 40px; display: flex; justify-content: space-between; align-items: center; }
        .ragu-wrapper { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #f39c12; cursor: pointer; user-select: none; }
        .ragu-wrapper input { width: 18px; height: 18px; cursor: pointer; }
        .focus-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary); margin-right: 15px; }

        /* Timer Melayang (Default Desktop) */
        #floatingTimer {
            display: none; position: fixed; top: 50px; left: 30px; z-index: 99999; 
            padding: 10px 25px; border-radius: 8px; font-size: 1.5rem; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 2px solid white;
            color: #ffeb3b; background: rgba(44, 62, 80, 0.9);
        }
		
		/* =========================================
           RESPONSIVE MOBILE (TAMPILAN HP) - REVISI FINAL
           ========================================= */
        @media (max-width: 768px) {
            body { 
                padding-bottom: 60px; 
                flex-direction: column; 
                overflow-y: auto; 
            }

            /* 1. LOGIN ESTETIK (KECIL) */
            .login-box {
                width: 85%; max-width: 320px; padding: 25px; border-radius: 15px;
            }

            /* 2. SIDEBAR KIRI (FULL LAYAR) */
            .sidebar-left {
                width: 100% !important; /* Full width */
                height: 100vh !important; /* Full Height */
                border-right: none;
                z-index: 100;
                position: fixed; /* Kunci biar full */
                top: 0; left: 0;
            }
            .sidebar-left .timer-container { display: none !important; }
            
            /* Pilihan Modul Full Layar */
            .modul-selector { 
                max-height: none !important; 
                height: calc(100% - 80px); /* Sisa tinggi dikurangi header */
                overflow-y: auto;
            }

            .main-content {
                width: 100% !important; margin: 0 !important; padding: 15px !important; flex: 1;
            }

            /* 3. SIDEBAR KANAN ESTETIK */
            .sidebar-right { display: none; }
            .sidebar-right.show-mobile {
                display: flex !important; flex-direction: column;
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                z-index: 15000; /* Di bawah Popup */
                background: white; padding-top: 50px; margin-right: 0 !important;
            }
            
            /* REVISI: Grid 6 Kolom di HP biar muat banyak & kecil */
            .nav-grid { 
                grid-template-columns: repeat(6, 1fr) !important; 
                gap: 5px !important; 
            }
            .nav-btn { font-size: 0.75rem !important; aspect-ratio: 1; border-radius: 4px; }
            
            /* REVISI PENTING LANGKAH 2: Hilangkan tombol Selesai di sidebar HP */
            .finish-container { display: none !important; }

            /* 4. TIMER HP (POJOK KIRI ATAS) */
            #floatingTimer {
                display: none; 
                position: fixed; top: 10px; left: 10px; right: auto; /* KIRI */
                font-size: 13px; padding: 6px 12px;
                z-index: 99999; border-radius: 20px;
            }

            /* 5. UI TOMBOL ESTETIK */
            .footer-nav .btn {
                padding: 10px 15px !important; font-size: 0.85rem !important; width: 48%; border-radius: 8px;
            }
            
            #btnMobileNav { 
                display: none; /* Default Hidden, muncul via JS */
                bottom: 55px !important; /* Naik dikit biar aman dari watermark */
                right: 20px;
            }
            
            .close-sidebar-btn { display: block !important; }
            .question-box { font-size: 15px; line-height: 1.5; }
            .option-label { padding: 12px; margin-bottom: 10px; font-size: 0.95rem; }
            .question-header .focus-btn { display: none; } 
            
            /* Pas Ujian, Sidebar Kiri Hilang */
            body.ujian-berjalan .sidebar-left { display: none; }
        }

        #btnMobileNav {
            display: none; position: fixed; bottom: 55px; right: 20px;
            background: #2c3e50; color: white; padding: 12px 20px;
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000; border: none; font-weight: bold; cursor: pointer;
            align-items: center; gap: 8px;
        }

		#btnMobileModul {
            display: none; /* Default ngumpet */
            position: fixed; 
            bottom: 55px; /* Sejajar sama Daftar Soal */
            left: 20px;   /* DI SEBELAH KIRI */
            background: #2c3e50; 
            color: white; 
            padding: 12px 20px;
            border-radius: 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000; 
            border: none; 
            font-weight: bold; 
            cursor: pointer;
            align-items: center; gap: 8px;
        }

        .close-sidebar-btn {
            display: none; width: 100%; padding: 15px; background: #e74c3c;
            color: white; border: none; border-radius: 0; position: absolute; top:0; left:0;
            font-weight: bold; font-size: 16px; z-index: 10000;
        }
		/* =========================================
           KHUSUS LAPTOP / PC (Revisi Tombol Kanan & Ragu Luas)
           ========================================= */
        @media (min-width: 769px) {
            
            /* 1. Bikin area Ragu-ragu jadi panjang ngisi ruang kosong kiri */
            .ragu-wrapper {
                flex: 1;                 /* Ambil sisa ruang kosong */
                background-color: #fdfdfd; 
                padding: 12px 20px;      /* Gue gedein dikit paddingnya biar enak kliknya */
                border-radius: 8px;
                margin-right: 20px;      /* Jarak ke tombol */
                cursor: pointer;
            }
            .ragu-wrapper:hover {
                background-color: #fff3e0; 
                border-color: var(--warning);
            }

            /* 2. RESET Tombol 'Sebelumnya' biar GAK mojok kiri lagi */
            #prevBtn {
                margin-right: 0 !important; /* Timpa style lama */
            }

            /* 3. Container tombol dibikin auto, biar gak menuhin layar */
            .footer-nav > div:last-child {
                width: auto !important;  
                gap: 15px !important;    /* Jarak antar tombol Sebelumnya & Selanjutnya */
            }
			
			/* --- RESTORED LOOK (MATCHING SCREENSHOT) --- */
			@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
			
			#loginOverlay {
			    /* Background Gedung MA + Kabut Putih Tebal */
			    background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.95)), 
			                url('https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Mahkamah_Agung_Republic_of_Indonesia.jpg/1200px-Mahkamah_Agung_Republic_of_Indonesia.jpg');
			    background-size: cover;
			    background-position: center;
			    background-attachment: fixed;
			    
			    position: fixed;
			    top: 0; left: 0;
			    width: 100%; height: 100%;
			    z-index: 9999;
			    overflow-y: auto;
			    overflow-x: hidden; /* Mencegah scroll samping */
			    font-family: 'Poppins', sans-serif; 
			    color: #333;
			    /* PENTING: display block biar ga bug sama JS login */
			    display: block !important; 
			}
			
			/* -- NAVBAR HIJAU SOLID (FULL WIDTH) -- */
			.landing-nav {
			    display: flex;
			    justify-content: space-between;
			    align-items: center;
			    box-sizing: border-box; /* Biar padding ga bikin melebar */
			    padding: 20px 40px; 
			    width: 100%; 
			    background-color: #004d00; /* Hijau Tua Solid */
			    color: white;
			    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
			}
			
			.nav-brand {
			    font-size: 1.3rem;
			    font-weight: 700;
			    color: #ffffff;
			    display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px;
			}
			
			/* Tombol Login Putih */
			.nav-login-btn {
			    background-color: #ffffff;
			    color: #004d00;
			    border: none;
			    padding: 10px 20px;
			    border-radius: 6px;
			    font-weight: 600;
			    font-size: 0.9rem;
			    cursor: pointer;
			    display: flex; align-items: center; gap: 10px; transition: all 0.2s;
			}
			.nav-login-btn:hover { background-color: #f0f0f0; transform: translateY(-1px); }
			
			/* -- HERO SECTION (GRID LAYOUT LAPTOP) -- */
			.hero-section {
			    display: grid;
			    grid-template-columns: 1.2fr 0.8fr; /* Kiri Teks, Kanan Gambar */
			    gap: 40px;
			    padding: 40px 60px;
			    max-width: 1300px;
			    margin: 0 auto;
			    align-items: center;
			    min-height: 80vh;
			    box-sizing: border-box;
			}
			
			/* Teks Kiri */
			.hero-content { text-align: left; }
			.hero-quote {
			    font-size: 3rem; font-weight: 800; line-height: 1.2; margin-bottom: 25px; color: #111;
			}
			.highlight-text { color: #006400; }
			
			/* Fitur List */
			.hero-features { list-style: none; padding: 0; margin: 0 0 40px 0; }
			.hero-features li {
			    font-size: 1rem; color: #444; margin-bottom: 12px;
			    display: flex; align-items: center; gap: 12px; font-weight: 500;
			}
			.feature-icon { color: #006400; font-size: 1.1rem; width: 20px; text-align: center; }
			
			.dev-footer {
			    font-size: 0.85rem; color: #666; margin-top: 30px; 
			    padding-top: 20px; border-top: 1px solid #ddd; font-weight: 600;
			}
			
			/* Gambar Kanan */
			.hero-image-container {
			    display: flex; justify-content: center; align-items: center;
			}
			.hero-illustration {
			    width: 100%; max-width: 500px; /* Ukuran pas di laptop */
			    height: auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));
			}
			
			/* RESPONSIF HP (Basic agar tidak hancur di HP) */
			@media (max-width: 992px) {
			    .landing-nav { padding: 15px 20px; }
			    .nav-brand { font-size: 1.1rem; }
			    /* Di HP teks login disembunyikan biar muat */
			    .nav-login-btn span { display: none; } 
			    
			    .hero-section { 
			        grid-template-columns: 1fr; /* Tumpuk 1 kolom */
			        padding: 30px 20px; text-align: center; 
			    }
			    .hero-content { order: 2; } /* Teks di bawah */
			    .hero-image-container { order: 1; margin-bottom: 20px; } /* Gambar di atas */
			    .hero-quote { font-size: 2rem; }
			    .hero-features li { justify-content: center; }
			}
		}
    </style>
</head>
<body>

    <div id="floatingTimer">00:00:00</div>

	<button id="btnMobileModul" onclick="toggleMobileModul()">
        üìö Daftar Modul
    </button>
	
	<button id="btnMobileNav" onclick="toggleMobileSidebar()">
        üì± Daftar Soal
    </button>

<div id="loginOverlay">
    
    <nav class="landing-nav">
        <div class="nav-brand">
            ‚öñÔ∏è CBT CAKIM PA 2026
        </div>
        
        <button class="nav-login-btn" onclick="handleLogin()">
            <img src="https://img.icons8.com/color/48/google-logo.png" width="25" height="25" alt="G">
            <span>Masuk dengan Google</span>
        </button>
    </nav>

    <section class="hero-section">
        
        <div class="hero-content">
            <h1 class="hero-quote">
                Belajar Hari Ini,<br>
                <span class="highlight-text">Dipercaya Esok Hari.</span><br>
                Ilmu Mengangkat Derajat, <br><span class="highlight-text"Integritas Menghormatinya.
            </h1>
            
            <ul class="hero-features">
                <li><i class="fas fa-database feature-icon"></i> <span>Database Soal Terlengkap</span></li>
                <li><i class="fas fa-chart-line feature-icon"></i> <span>Analisis & Peringkat Real-time</span></li>
                <li><i class="fas fa-gavel feature-icon"></i> <span>Pembahasan Hukum Mendalam</span></li>
                <li><i class="fas fa-mobile-alt feature-icon"></i> <span>Akses Fleksibel (HP & Laptop)</span></li>
            </ul>

            <div id="loginError" style="color: #c0392b; font-size: 0.9rem; margin-bottom: 20px;"></div>

            <div class="dev-footer">
                Developed by Ilham Nur Pratama - APP 2023 - PA SERANG
            </div>
        </div>

        <div class="hero-image-container">
            <img src="https://cdni.iconscout.com/illustration/premium/thumb/lawyer-giving-legal-advice-2975988-2478335.png" 
                 alt="Ilustrasi Hakim" 
                 class="hero-illustration">
        </div>
    </section>
</div>
	
    <div id="appSection" style="display:none;">
        <div class="watermark" id="watermark">By: Ilham Nur Pratama - APP 23 - PA Serang</div>
        
        <div class="sidebar-left">
            <div class="sidebar-header">
                <h3>CBT CAKIM 2026</h3>
                <div class="user-profile">
                   <img id="userAvatar" src="" class="user-avatar" alt="">
                   <span id="roleDisplay">Peserta</span>
                </div>
                <div class="timer-container" id="timerDisplay">00:00:00</div>
            </div>
            <div class="modul-selector">
                <small style="color: #666; display:block; margin-bottom:10px; font-weight:bold;">MATERI TERBARU (URUT):</small>
                
                <button class="modul-btn active-modul" id="btn-modul1" onclick="switchDatabase('modul1')">Modul 1: Kekuasaan Kehakiman</button>
                <button class="modul-btn" id="btn-modul2" onclick="switchDatabase('modul2')">Modul 2: Mahkamah Agung</button>
                <button class="modul-btn" id="btn-modul3" onclick="switchDatabase('modul3')">Modul 3: Peradilan Agama</button>
                <button class="modul-btn" id="btn-modul4" onclick="switchDatabase('modul4')">Modul 4: Pendaftaran & Relaas</button>
                <button class="modul-btn" id="btn-modul5" onclick="switchDatabase('modul5')">Modul 5: Gugatan & Permohonan</button>
                <button class="modul-btn" id="btn-modul6" onclick="switchDatabase('modul6')">Modul 6: PMH & Wanprestasi</button>
                <button class="modul-btn" id="btn-modul7" onclick="switchDatabase('modul7')">Modul 7: Mediasi</button>
                <button class="modul-btn" id="btn-modul8" onclick="switchDatabase('modul8')">Modul 8: Perkawinan (KHI)</button>
                <button class="modul-btn" id="btn-modul8.1" onclick="switchDatabase('modul8.1')">Modul 8.1: Perkawinan (Lanjutan)</button>
                <button class="modul-btn" id="btn-modul8.2" onclick="switchDatabase('modul8.2')">Modul 8.2: Perkawinan (Akhir)</button>
                <button class="modul-btn" id="btn-modul8.3" onclick="switchDatabase('modul8.3')">Modul 8.3: Perkawinan (UU 1/1974)</button>
                <button class="modul-btn" id="btn-modul8.4" onclick="switchDatabase('modul8.4')">Modul 8.4: Pelaksana (PP 9/1975)</button>
                <button class="modul-btn" id="btn-modul9" onclick="switchDatabase('modul9')">Modul 9: Perwalian & Pengangkatan</button>
                <button class="modul-btn" id="btn-modul10" onclick="switchDatabase('modul10')">Modul 10: Waris Islam (Dasar)</button>
                <button class="modul-btn" id="btn-modul10.1" onclick="switchDatabase('modul10.1')">Modul 10.1: Waris (KHI)</button>
                <button class="modul-btn" id="btn-modul10.2" onclick="switchDatabase('modul10.2')">Modul 10.2: Waris (BW)</button>
                <button class="modul-btn" id="btn-modul10.3" onclick="switchDatabase('modul10.3')">Modul 10.3: Studi Kasus Waris</button>
                <button class="modul-btn" id="btn-modul11" onclick="switchDatabase('modul11')">Modul 11: Wasiat & Hibah</button>
                <button class="modul-btn" id="btn-modul12" onclick="switchDatabase('modul12')">Modul 12: Sita Jaminan</button> 
                <button class="modul-btn" id="btn-modul13" onclick="switchDatabase('modul13')">Modul 13: Ekonomi Syariah</button>
                <button class="modul-btn" id="btn-modul13.1" onclick="switchDatabase('modul13.1')">Modul 13.1: Akad Syariah</button>
                <button class="modul-btn" id="btn-modul13.2" onclick="switchDatabase('modul13.2')">Modul 13.2: Kasus Akad</button>
                <button class="modul-btn" id="btn-modul14" onclick="switchDatabase('modul14')">Modul 14: Perwakafan</button>
                <button class="modul-btn" id="btn-modul15" onclick="switchDatabase('modul15')">Modul 15: Buku Saku PA 1.1</button>
                <button class="modul-btn" id="btn-modul15.1" onclick="switchDatabase('modul15.1')">Modul 15.1: Buku Saku PA 1.2</button>
                <button class="modul-btn" id="btn-modul15.2" onclick="switchDatabase('modul15.2')">Modul 15.2: Buku Saku PA 1.3</button>
           </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="question-header">
                    <div style="display:flex; align-items:center;">
                        <button class="focus-btn" onclick="toggleFocusMode()" title="Mode Fokus">‚ò∞</button>
                        <div>
                            <span style="font-size: 1.2rem; font-weight: bold; color: var(--secondary); display:block;" id="modulTitle">Modul 1</span>
                            <span style="font-size: 1rem; color: #7f8c8d;">Soal No. <span id="qNum" style="font-weight:bold; color:var(--accent);">1</span></span>
                        </div>
                    </div>
                    <span id="modeIndicator" style="color: var(--warning); font-weight: bold; background:#fff3e0; padding:5px 15px; border-radius:20px; border:1px solid #ffe0b2;">Mode: Ujian</span>
                </div>

                <div id="questionText" class="question-text"></div>
                <div id="optionsContainer" style="display:flex; flex-direction:column; gap:10px;"></div>

                <div id="feedbackBox" class="feedback-box">
                    <h3 style="margin-top:0;">Pembahasan</h3>
                    <p id="feedbackText"></p>
                    <span id="feedbackCite" style="display:block; margin-top:10px; font-style:italic; font-weight:bold; color:#555;"></span>
                </div>

                <div class="footer-nav">
                    <div class="ragu-wrapper">
                        <input type="checkbox" id="checkRagu" onchange="toggleRagu()">
                        <label for="checkRagu">Ragu-Ragu</label>
                    </div>

                    <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                        <button class="btn btn-prev" id="prevBtn" onclick="changeQuestion(-1)" style="margin-right: auto;">‚ùÆ Sebelumnya</button>
                        <button class="btn btn-next" id="nextBtn" onclick="changeQuestion(1)">Selanjutnya ‚ùØ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-right">
            <div class="right-header">
                <button class="btn-small" id="btnShowScore" onclick="showResult()" style="background:#9b59b6; display:none;">üèÜ Nilai</button>
                <button class="btn-small btn-rank" onclick="openLeaderboard()">üèÜ Peringkat</button>
                <button class="btn-small btn-stats" onclick="openStats()">üìä Data</button>
                <button class="btn-small btn-logout" onclick="handleLogout()">üö™ Keluar</button>
            </div>
            
            <div class="sidebar-info">
                <div id="progressText" style="font-weight:bold; margin-bottom:10px; color:var(--accent);">Menjawab: 0/0</div>
                <div style="display:flex; justify-content:center; gap:15px;">
                    <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:var(--filled); border-radius:2px;"></span> Dijawab</div>
                    <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:#f1c40f; border-radius:2px;"></span> Ragu</div>
                    <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:white; border:1px solid #ccc; border-radius:2px;"></span> Belum</div>
                </div>
            </div>

            <div class="nav-container">
                <div class="nav-grid" id="navGrid"></div>
            </div>

            <div class="finish-container">
                <button class="btn btn-finish" onclick="confirmFinish()">Selesai</button>
            </div>
        </div>
    </div>

    <div id="resultOverlay" class="result-overlay">
        <div class="result-box" style="width:400px;">
            <h2>Hasil Ujian</h2>
            <p id="passStatus" style="font-size:1.5rem; font-weight:bold; margin:5px 0;"></p>
            <p>Skor Akhir:</p>
            <div class="score-circle" id="finalScore">0</div>
            <p id="resultMsg" style="font-weight:500; color:#555;"></p>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button onclick="startReviewWrong()" id="btnReviewWrong" style="width:100%; display:none; margin-bottom:10px; background-color: #d32f2f; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold;">üîç Review Jawaban Salah</button>
                <button class="btn btn-next" onclick="closeResult()" style="width:100%;">Lihat Pembahasan</button>
                <button class="btn btn-rank" onclick="closeResult(); openLeaderboard();" style="width:100%;">Lihat Peringkat Teman</button>
                <button class="btn" onclick="closeResult(); openStats();" style="width:100%; background:var(--primary);">Lihat Grafik Lengkap</button>
                <button class="btn" onclick="backToMenu()" style="width:100%; background:#7f8c8d; margin-top:5px;">üè† Kembali ke Menu Utama</button>
            </div>
        </div>
    </div>

    <div id="leaderboardOverlay" class="result-overlay">
        <div class="result-box" style="width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">üèÜ Top Skor - <span id="lbModulName">Modul Ini</span></h2>
                <button onclick="closeLeaderboard()" style="background:none; border:none; font-size:2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="stats-table">
                    <thead><tr><th style="width:10%">#</th><th>Nama</th><th style="width:20%">Skor</th><th style="width:25%">Waktu</th></tr></thead>
                    <tbody id="leaderboardBody"><tr><td colspan="4">Memuat data...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statsOverlay" class="result-overlay">
        <div class="result-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Statistik Belajar</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="resetStats()" style="background-color:var(--warning); border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; color:white; font-size:0.8rem;">üîÑ Reset Data Modul Ini</button>
                    <button onclick="closeStats()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--danger);">&times;</button>
                </div>
            </div>
            <h4 id="statsTitle" class="stats-section-title">Data Modul Ini: -</h4>
            <div style="width: 100%; height: 200px; margin-bottom: 20px;"><canvas id="statsChart"></canvas></div>
            <div style="max-height: 150px; overflow-y: auto; margin-bottom:20px;">
                <table class="stats-table">
                    <thead><tr><th>No</th><th>Tanggal & Jam</th><th>Skor</th><th>Benar</th><th>Salah</th></tr></thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
            <h4 class="stats-section-title">üèÜ Peta Kekuatan</h4>
            <div style="width: 100%; height: 250px; margin-bottom: 20px;"><canvas id="allModulesChart"></canvas></div>
            <div style="margin-top:20px;"><button class="btn" onclick="closeStats()" style="width:100%; background-color: var(--danger);">Tutup</button></div>
        </div>
    </div>

<script type="module">
    // 1. IMPORT (Sudah ditambahkan: writeBatch, doc)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, deleteDoc, writeBatch, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAC4Tskg8XC1N0a13xcsV3A1Mq_8mDnY-A",
        authDomain: "simulasi-cbt-cakim-2026.firebaseapp.com",
        projectId: "simulasi-cbt-cakim-2026",
        storageBucket: "simulasi-cbt-cakim-2026.firebasestorage.app",
        messagingSenderId: "209182753461",
        appId: "1:209182753461:web:1aa2201fa7c73e581234fc",
        measurementId: "G-NDNKMSMWV2"
    };

    // 3. INIT
    let db, auth, provider, currentUser;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        provider = new GoogleAuthProvider();
    }

    window.handleLogin = async () => {
        if(!auth) { alert("Konfigurasi Firebase belum dipasang!"); return; }
        try { await signInWithPopup(auth, provider); } 
        catch (error) { document.getElementById('loginError').innerText = error.message; }
    };

    window.handleLogout = () => { if(auth) signOut(auth).then(() => location.reload()); };

    if(auth) {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.setProperty('display', 'none', 'important');
                document.getElementById('appSection').style.display = 'flex';
                tampilkanLobby();
                document.getElementById('roleDisplay').innerText = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('floatingTimer').style.display = 'none';
            } else {
                document.getElementById('loginOverlay').style.setProperty('display', 'block', 'important');
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('floatingTimer').style.display = 'none';
            }
        });
    }

    window.saveScoreToCloud = async (modulId, skor) => {
        if (!currentUser || !db) return;
        try {
            await addDoc(collection(db, "leaderboard"), {
                uid: currentUser.uid, nama: currentUser.displayName, modul: modulId, skor: skor, tanggal: new Date()
            });
        } catch (e) { console.error("Gagal simpan skor:", e); }
    };

    window.openLeaderboard = async () => {
        if (!db) { alert("Database belum connect"); return; }
        document.getElementById('leaderboardOverlay').style.display = 'flex';
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = '<tr><td colspan="4">Sedang memuat data...</td></tr>';
        document.getElementById('lbModulName').innerText = document.getElementById('modulTitle').innerText;

        const q = query(collection(db, "leaderboard"), where("modul", "==", currentDatabaseId || "modul1"), orderBy("skor", "desc"), limit(100));
        try {
            const snapshot = await getDocs(q); 
            const bestScores = {};
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (!bestScores[data.nama] || parseInt(data.skor) > parseInt(bestScores[data.nama].skor)) {
                    bestScores[data.nama] = data;
                }
            });
            let sortedData = Object.values(bestScores).sort((a, b) => b.skor - a.skor);
            tbody.innerHTML = '';
            if (sortedData.length === 0) tbody.innerHTML = '<tr><td colspan="4">Belum ada data.</td></tr>';
            else {
                sortedData.forEach((val, index) => {
                    let rowStyle = index === 0 ? 'style="background:#fff3cd; font-weight:bold;"' : (index === 1 ? 'style="background:#f8f9fa; font-weight:bold;"' : '');
                    let tgl = val.tanggal && val.tanggal.seconds ? new Date(val.tanggal.seconds * 1000).toLocaleDateString('id-ID') : '-';
                    let tr = document.createElement('tr');
                    tr.innerHTML = `<td ${rowStyle}>${index + 1}</td><td ${rowStyle}>${val.nama}</td><td ${rowStyle}>${val.skor}</td><td ${rowStyle}>${tgl}</td>`;
                    tbody.appendChild(tr);
                });
            }
        } catch (error) { console.error(error); tbody.innerHTML = '<tr><td colspan="4">Gagal memuat.</td></tr>'; }
    };

    window.closeLeaderboard = () => { document.getElementById('leaderboardOverlay').style.display = 'none'; };

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
		
    // 3. LOGIKA APLIKASI
    let currentModulKey = 'modul1';
    let currentQuestions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let raguStatus = [];
    let isSubmitted = false;
    let timerInterval;
    let timeRemaining;
    let totalExamTime = 0;
    let isReviewMode = false;
    let wrongIndices = [];

    window.currentDatabaseId = 'modul1';

	window.toggleMobileSidebar = function() {
        const sidebar = document.querySelector('.sidebar-right');
        const floatingTimer = document.getElementById('floatingTimer');
        
        // 1. Buka/Tutup Sidebar
        sidebar.classList.toggle('show-mobile');

        // 2. LOGIKA BARU: Cek sidebar lagi kebuka apa ngga?
        if (sidebar.classList.contains('show-mobile')) {
            // Kalau Sidebar Kebuka -> Timer Umpetin (Biar bersih)
            if(floatingTimer) floatingTimer.style.setProperty('display', 'none', 'important');
        } else {
            // Kalau Sidebar Tutup & Ujian Jalan -> Timer Munculin Lagi
            if (document.body.classList.contains('ujian-berjalan') && floatingTimer) {
                floatingTimer.style.display = 'block';
            }
        }

        // 3. Logic bikin tombol Tutup (Close) di sidebar
        if (!document.getElementById('btnCloseMobile')) {
            const btnClose = document.createElement('button');
            btnClose.id = 'btnCloseMobile';
            btnClose.className = 'close-sidebar-btn';
            btnClose.innerHTML = 'Tutup Daftar Soal ‚úñÔ∏è';
            btnClose.onclick = window.toggleMobileSidebar;
            sidebar.insertBefore(btnClose, sidebar.firstChild);
        }
    }

	// REVISI: Buka Sidebar Modul dengan Mode BERSIH (Tanpa Timer/Tombol Lain)
    window.toggleMobileModul = function() {
        const sidebar = document.querySelector('.sidebar-left');
        const timer = document.getElementById('floatingTimer');
        const btnSoal = document.getElementById('btnMobileNav');
        const btnModul = document.getElementById('btnMobileModul');

        if (sidebar.style.display === 'flex') {
            // Kalau mau TUTUP (Manual/Otomatis)
            sidebar.style.display = ''; 
        } else {
            // Kalau mau BUKA
            sidebar.style.display = 'flex'; 
            
            // 1. Umpetin Timer biar bersih
            if(timer) timer.style.display = 'none';

            // 2. Umpetin Tombol Navigasi Bawah
            if(btnSoal) btnSoal.style.display = 'none';
            if(btnModul) btnModul.style.display = 'none';
        }
    }

    document.addEventListener('keydown', function(event) {
        if(document.getElementById('appSection').style.display === 'none') return;
        switch(event.key) {
            case "ArrowRight": changeQuestion(1); break;
            case "ArrowLeft": changeQuestion(-1); break;
            case "a": case "A": selectKey(0); break;
            case "b": case "B": selectKey(1); break;
            case "c": case "C": selectKey(2); break;
            case "d": case "D": selectKey(3); break;
            case "e": case "E":
                if(!isSubmitted) {
                    const chk = document.getElementById('checkRagu');
                    if(chk) { chk.checked = !chk.checked; toggleRagu(); }
                }
                break;
        }
    });

    function selectKey(idx) {
        if(!isSubmitted && !isReviewMode) {
            let labels = document.getElementsByClassName('option-label');
            if(labels[idx]) labels[idx].click();
        }
    }

window.switchDatabase = async function(key) {
        // 1. Reset Timer & State
        if (typeof timerInterval !== 'undefined' && timerInterval) clearInterval(timerInterval);
        currentModulKey = key;
        window.currentDatabaseId = key;
        
        // 2. Tampilan Loading
        const qText = document.getElementById('questionText');
        const optCont = document.getElementById('optionsContainer');
        const footer = document.querySelector('.footer-nav');
        
        if(qText) qText.innerHTML = '<div style="text-align:center; padding:30px;">‚è≥ <b>Sedang mengambil soal dari server...</b><br><small>Tunggu sebentar ya!</small></div>';
        if(optCont) optCont.innerHTML = '';
        if(footer) footer.style.visibility = 'hidden';

        try {
            // 3. AMBIL DATA DARI FIREBASE
            const docRef = doc(db, "bank_soal", key);
            const docSnap = await getDoc(docRef);
            let judulModul = "Modul Latihan";
            if (docSnap.exists()) {
                judulModul = docSnap.data().title;
            }

            const qRef = collection(db, "bank_soal", key, "daftar_soal");
            const qSnap = await getDocs(qRef);

            if (qSnap.empty) {
                alert("‚ö†Ô∏è Soal untuk modul ini belum di-upload ke server!");
                if(qText) qText.innerText = "Belum ada soal.";
                return;
            }

            let rawQuestions = [];
            qSnap.forEach((doc) => {
                rawQuestions.push(doc.data());
            });

            // --- LOGIC SHUFFLE ---
            shuffleArray(rawQuestions); 
            rawQuestions.forEach(q => {
                if(q.options && q.answer < q.options.length) {
                    let correctText = q.options[q.answer]; 
                    shuffleArray(q.options); 
                    q.answer = q.options.indexOf(correctText); 
                }
            });

            currentQuestions = rawQuestions;
            userAnswers = new Array(currentQuestions.length).fill(null);
            raguStatus = new Array(currentQuestions.length).fill(false);
            isSubmitted = false;
            isReviewMode = false;
            currentIdx = 0;

            // Update UI
            document.querySelectorAll('.modul-btn').forEach(btn => btn.classList.remove('active-modul'));
            const activeBtn = document.getElementById('btn-'+key);
            if(activeBtn) activeBtn.classList.add('active-modul');

            const titleEl = document.getElementById('modulTitle');
            if(titleEl) titleEl.innerText = judulModul;
            
            const modeInd = document.getElementById('modeIndicator');
            if(modeInd) {
                modeInd.innerText = "Mode: Ujian";
                modeInd.style = "color: var(--warning); font-weight: bold; background:#fff3e0; padding:5px 15px; border-radius:20px; border:1px solid #ffe0b2; display:block;";
            }
            
            const finishCont = document.querySelector('.finish-container');
            if(finishCont) finishCont.style.display = 'block';
            
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('statsOverlay').style.display = 'none';
            document.getElementById('leaderboardOverlay').style.display = 'none';
            const btnScore = document.getElementById('btnShowScore');
            if(btnScore) btnScore.style.display = 'none';
            
            if(footer) {
                footer.style.visibility = 'visible';
                footer.style.display = 'flex';
            }
            if(qText) qText.style.display = 'block';
            
            // Setup Timer
            totalExamTime = currentQuestions.length * 25; 
            timeRemaining = totalExamTime;
            
            updateTimerDisplay();
            startTimer();
            renderSidebarGrid();
            loadQuestion(0);
            
            // ==========================================
            // ‚úÖ LOGIC KHUSUS HP (Sesuai Request Lo) ‚úÖ
            // ==========================================
            if(window.innerWidth <= 768) {
                document.body.classList.add('ujian-berjalan'); 
                const btnMobile = document.getElementById('btnMobileNav');
                if(btnMobile) btnMobile.style.display = 'flex';
                const btnModul = document.getElementById('btnMobileModul');
                if(btnModul) btnModul.style.display = 'flex';
                const timer = document.getElementById('floatingTimer');
                if(timer) timer.style.display = 'block';
                const sbLeft = document.querySelector('.sidebar-left');
                if(sbLeft) sbLeft.style.display = ''; 
            }

        } catch (e) {
            console.error("Error ambil data:", e);
            alert("Gagal memuat soal: " + e.message);
        }
    };

	// ==========================================
    // üõ†Ô∏è ALAT BANTU REVISI MASSAL (ADMIN ONLY)
    // ==========================================

    // 1. FITUR DOWNLOAD SOAL (Buat diambil teks-nya)
    window.downloadSoal = async function(modulKey) {
        console.log(`Sedang mendownload soal ${modulKey}...`);
        const qRef = collection(db, "bank_soal", modulKey, "daftar_soal");
        const snapshot = await getDocs(qRef);
        
        let dataSoal = [];
        snapshot.forEach(doc => {
            // Kita cuma ambil data penting, ID gak usah karena nanti digenerate ulang
            const d = doc.data();
            dataSoal.push({
                q: d.q,
                options: d.options,
                answer: d.answer,
                explanation: d.explanation,
                cite: d.cite
            });
        });

        // Tampilkan di Console biar bisa dicopy
        console.log("‚úÖ COPY TEKS DI BAWAH INI KE NOTEPAD:");
        console.log(JSON.stringify(dataSoal, null, 2)); 
        return dataSoal;
    };

    // 2. FITUR TIMPA/UPDATE SATU MODUL (Hapus Lama -> Masukin Baru)
    window.timpaModul = async function(modulKey, dataBaruJson) {
        if(!confirm(`‚ö†Ô∏è BAHAYA: Ini akan MENGHAPUS semua soal lama di ${modulKey} dan menggantinya dengan data baru. Yakin?`)) return;

        console.log("üî• Mulai proses penghapusan data lama...");
        
        // A. Hapus Soal Lama Dulu
        const qRef = collection(db, "bank_soal", modulKey, "daftar_soal");
        const snapshot = await getDocs(qRef);
        const batchDelete = writeBatch(db);
        
        snapshot.forEach(doc => {
            batchDelete.delete(doc.ref);
        });
        await batchDelete.commit();
        console.log("üóëÔ∏è Data lama terhapus.");

        // B. Upload Data Baru
        console.log("üöÄ Mengupload data revisi...");
        // Pecah batch kayak dulu biar aman
        const chunks = [];
        let currentBatch = writeBatch(db);
        let count = 0;

        for (const soal of dataBaruJson) {
            const newDocRef = doc(collection(db, "bank_soal", modulKey, "daftar_soal"));
            currentBatch.set(newDocRef, soal);
            count++;
            if (count >= 490) {
                chunks.push(currentBatch);
                currentBatch = writeBatch(db);
                count = 0;
            }
        }
        if (count > 0) chunks.push(currentBatch);

        for (let batch of chunks) await batch.commit();
        
        alert("‚úÖ SUKSES! Modul berhasil direvisi total.");
        location.reload(); // Refresh biar kelihatan hasilnya
    };
	
    function startTimer() {
        timerInterval = setInterval(() => {
            if(timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); }
            else { clearInterval(timerInterval); finishTime(); }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        const textWaktu = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        const t1 = document.getElementById('timerDisplay');
        const t2 = document.getElementById('floatingTimer');
        if(t1) t1.innerText = textWaktu;
        if(t2) t2.innerText = textWaktu;
        
        let persentase = (timeRemaining / totalExamTime) * 100;
        let colorClass = 'timer-green';
        if (persentase <= 10) colorClass = 'timer-panic';
        else if (persentase <= 30) colorClass = 'timer-yellow';

        if(t1) t1.className = 'timer-container ' + colorClass;
        if(t2) t2.className = colorClass;
    }

    function finishTime() { alert("Waktu Habis!"); submitQuiz(); }

    function renderSidebarGrid() {
        const grid = document.getElementById('navGrid');
        grid.innerHTML = '';
        currentQuestions.forEach((_, idx) => {
            const btn = document.createElement('div');
            btn.className = 'nav-btn';
            btn.id = `nav-${idx}`;
            btn.innerText = idx + 1;
           // REVISI: Pas klik nomor, load soal TERUS tutup sidebar kalo di HP
            btn.onclick = () => {
                loadQuestion(idx);
                // Cek: Kalau ini HP dan Sidebar lagi kebuka, kita tutup paksa
                if (window.innerWidth <= 768) {
                     const sb = document.querySelector('.sidebar-right');
                     if (sb && sb.classList.contains('show-mobile')) {
                         window.toggleMobileSidebar(); 
                     }
                }
            };
            grid.appendChild(btn);
        });
        updateSidebarStatus();
    }

    function updateSidebarStatus() {
        currentQuestions.forEach((q, idx) => {
            const btn = document.getElementById(`nav-${idx}`);
            if(!btn) return;
            btn.classList.remove('active', 'filled', 'correct', 'wrong', 'ragu');
            if (idx === currentIdx) btn.classList.add('active');
            if (isSubmitted) {
                if (userAnswers[idx] === q.answer) btn.classList.add('correct');
                else btn.classList.add('wrong');
            } else {
                if (raguStatus[idx]) btn.classList.add('ragu');
                else if (userAnswers[idx] !== null) btn.classList.add('filled');
            }
        });
    }

    function loadQuestion(idx) {
        document.querySelector('.question-header').style.visibility = 'visible';
        document.querySelector('.footer-nav').style.visibility = 'visible';
        currentIdx = idx;
        const q = currentQuestions[idx];
        if (!q) return;

        document.getElementById('qNum').innerText = idx + 1;
        document.getElementById('questionText').innerText = q.q;
        
        updateSidebarStatus();
        updateProgress();
        
        document.getElementById('prevBtn').disabled = (isReviewMode ? false : idx === 0);
        
        // --- LOGIKA TOMBOL NEXT vs SELESAI (REVISI FINAL) ---
        const btnNext = document.getElementById('nextBtn');
        btnNext.style.display = 'block'; // Reset dulu biar muncul default

        if (!isReviewMode && idx === currentQuestions.length - 1) {
            // KONDISI: INI SOAL TERAKHIR
            
            if (window.innerWidth > 768) {
                // MODUS LAPTOP: Tombol Next diumpetin (Biar pake tombol Sidebar aja)
                btnNext.style.display = 'none';
            } else {
                // MODUS HP: Tombol Next berubah jadi SELESAI (Wajib ada)
                btnNext.innerHTML = "Selesai ‚úÖ";
                btnNext.className = "btn btn-finish"; 
                btnNext.onclick = confirmFinish; 
            }

        } else {
            // KONDISI: BUKAN SOAL TERAKHIR (Normal)
            btnNext.innerHTML = "Selanjutnya ‚ùØ";
            btnNext.className = "btn btn-next"; 
            btnNext.onclick = () => changeQuestion(1);
        }
        
        if (isReviewMode) {
             btnNext.style.display = 'block';
             btnNext.onclick = () => changeQuestion(1);
        }

        const fb = document.getElementById('feedbackBox');
        if (isSubmitted) {
            fb.style.display = 'block';
            fb.classList.add('show');
            document.getElementById('feedbackText').innerText = q.explanation;
            document.getElementById('feedbackCite').innerText = "Sumber: " + q.cite;
        } else { 
            fb.style.display = 'none';
            fb.classList.remove('show'); 
        }

        const cont = document.getElementById('optionsContainer');
        cont.innerHTML = '';
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option-label';
            if(isSubmitted) {
                div.style.cursor = 'default';
                if(userAnswers[idx] === i) {
                    div.innerHTML = i === q.answer ? opt + ' ‚úÖ' : opt + ' ‚ùå';
                    div.classList.add(i === q.answer ? 'review-correct' : 'review-wrong');
                }
                else if(i === q.answer) {
                    div.innerHTML = opt + ' ‚¨ÖÔ∏è (Jawaban Benar)';
                    div.classList.add('review-correct');
                } else {
                    div.innerHTML = opt;
                }
            } else {
                div.innerHTML = opt;
                div.onclick = () => { 
                    if(!isSubmitted) { 
                        userAnswers[idx] = i; 
                        raguStatus[idx] = false; 
                        loadQuestion(idx); 
                    } 
                };
                if(userAnswers[idx] === i) div.classList.add('selected');
            }
            cont.appendChild(div);
        });

        const chk = document.getElementById('checkRagu');
        if(chk) {
            chk.checked = raguStatus[idx] || false;
            chk.disabled = isSubmitted;
        }
    }

    window.submitQuiz = function() {
        if(timerInterval) clearInterval(timerInterval);
        isSubmitted = true;
        let score = 0;
        let correctCount = 0;
        let wrongCount = 0;
        wrongIndices = [];

        userAnswers.forEach((a, i) => {
            if(a === currentQuestions[i].answer) {
                score++; correctCount++;
            } else {
                wrongCount++;
                wrongIndices.push(i);
            }
        });
        
        const final = Math.round((score/currentQuestions.length)*100);
        if (typeof window.saveScoreToCloud === 'function') {
            window.saveScoreToCloud(currentModulKey, final);
        }
        
        document.getElementById('resultOverlay').style.display = 'flex';
        const scoreCircle = document.getElementById('finalScore');
        const passStatus = document.getElementById('passStatus');
        const msg = document.getElementById('resultMsg');
        
        scoreCircle.innerText = final;
        if (final >= 70) {
            scoreCircle.style.background = "var(--pass)";
            passStatus.innerText = "LULUS";
            passStatus.style.color = "var(--pass)";
            msg.innerText = "Selamat! Anda memenuhi standar Cakim.";
        } else {
            scoreCircle.style.background = "var(--fail)";
            passStatus.innerText = "TIDAK LULUS";
            passStatus.style.color = "var(--fail)";
            msg.innerText = "Perbaiki lagi, target minimal 70.";
        }
        
        const btnReview = document.getElementById('btnReviewWrong');
        if (wrongCount > 0) {
            btnReview.style.display = 'block';
            btnReview.innerText = `üîç Review ${wrongCount} Jawaban Salah`;
        } else {
            btnReview.style.display = 'none';
        }

        document.getElementById('modeIndicator').innerText = "PEMBAHASAN";
        document.getElementById('modeIndicator').style.color = "var(--success)";
        document.querySelector('.finish-container').style.display = 'none';
        document.getElementById('btnShowScore').style.display = 'flex';

        saveAndShowChart(final, correctCount, wrongCount);
        loadQuestion(currentIdx);
    }

    window.confirmFinish = function() {
        const emptyCount = userAnswers.filter(a => a === null).length;
        const raguCount = raguStatus.filter(r => r === true).length;
        let msg = "Yakin mau menyelesaikan ujian?";
        if(emptyCount > 0 || raguCount > 0) {
            msg = `‚ö†Ô∏è PERHATIAN!\n\n`;
            if (raguCount > 0) msg += `- Ada ${raguCount} soal RAGU-RAGU\n`;
            if (emptyCount > 0) msg += `- Ada ${emptyCount} soal BELUM DIJAWAB\n`;
            msg += `\nYakin mau dikumpulkan sekarang?`;
        }
        if(confirm(msg)) submitQuiz();
    }

    window.closeResult = function() {
		// TAMBAHAN: Tutup sidebar otomatis pas masuk pembahasan
        if (window.innerWidth <= 768) {
            const sb = document.querySelector('.sidebar-right');
            if (sb && sb.classList.contains('show-mobile')) {
                window.toggleMobileSidebar();
            }
        }
        document.getElementById('resultOverlay').style.display = 'none';
        isReviewMode = false; 
        const ind = document.getElementById('modeIndicator');
        if (ind) {
            ind.innerText = "PEMBAHASAN";
            ind.style.background = "#e8f5e9";
            ind.style.color = "#2e7d32";
            ind.style.border = "1px solid #c8e6c9";
        }
        document.getElementById('prevBtn').disabled = false;
        document.getElementById('nextBtn').style.display = 'block';
        const mainContent = document.querySelector('.main-content');
        if(mainContent) mainContent.scrollTop = 0;
        loadQuestion(currentIdx);
    };

    window.startReviewWrong = function() {
        if (wrongIndices.length === 0) return;
		// TAMBAHAN: Tutup sidebar otomatis pas review salah
        if (window.innerWidth <= 768) {
            const sb = document.querySelector('.sidebar-right');
            if (sb && sb.classList.contains('show-mobile')) {
                window.toggleMobileSidebar();
            }
        }
        isReviewMode = true;
        document.getElementById('resultOverlay').style.display = 'none';
        const ind = document.getElementById('modeIndicator');
        ind.innerText = "MODE: REVIEW SALAH";
        ind.style.background = "#ffebee";
        ind.style.color = "#c62828";
        ind.style.border = "1px solid #ffcdd2";
        loadQuestion(wrongIndices[0]);
    };

    window.changeQuestion = function(step) {
        if (isReviewMode) {
            let currentWrongPos = wrongIndices.indexOf(currentIdx);
            if (currentWrongPos !== -1) {
                let nextWrongPos = currentWrongPos + step;
                if (nextWrongPos >= wrongIndices.length) nextWrongPos = 0;
                if (nextWrongPos < 0) nextWrongPos = wrongIndices.length - 1;
                loadQuestion(wrongIndices[nextWrongPos]);
            } else {
                if (step > 0) {
                    let nextVal = wrongIndices.find(idx => idx > currentIdx);
                    loadQuestion(nextVal !== undefined ? nextVal : wrongIndices[0]);
                } else {
                    let prevVal = [...wrongIndices].reverse().find(idx => idx < currentIdx);
                    loadQuestion(prevVal !== undefined ? prevVal : wrongIndices[wrongIndices.length - 1]);
                }
            }
        } else {
            const next = currentIdx + step;
            if (next >= 0 && next < currentQuestions.length) loadQuestion(next);
        }
    };

   window.backToMenu = function() {
        if(confirm("Yakin mau kembali ke menu utama? Progres saat ini akan di-reset.")) {
            // Matikan timer interval
            if(window.timerInterval) clearInterval(window.timerInterval);
            
            // 1. Umpetin Tombol-Tombol Mobile (Soal & Modul)
            const btnMobile = document.getElementById('btnMobileNav');
            const btnModul = document.getElementById('btnMobileModul');
            if(btnMobile) btnMobile.style.display = 'none';
            if(btnModul) btnModul.style.display = 'none'; 

            // 2. Tutup semua Overlay (Hasil, Stats, Peringkat)
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('statsOverlay').style.display = 'none';
            document.getElementById('leaderboardOverlay').style.display = 'none';

            // 3. RESET SIDEBAR KIRI (Modul)
            const sbLeft = document.querySelector('.sidebar-left');
            if(sbLeft) {
                sbLeft.style.display = ''; // Reset CSS biar muncul normal di Lobby
            }

            // 4. RESET SIDEBAR KANAN (Soal) - FIX KHUSUS HP
            const sbRight = document.querySelector('.sidebar-right');
            if(sbRight) {
                sbRight.classList.remove('show-mobile'); // Hapus mode mobile yang nyangkut
                sbRight.style.display = ''; // Reset display aman buat laptop
            }

            // 5. Reset Class Mode Ujian di Body
            document.body.classList.remove('ujian-berjalan');
            
            // 6. Umpetin Timer & Reset Judul Header
            const timer = document.getElementById('floatingTimer');
            if(timer) timer.style.display = 'none';
            
            const modulTitle = document.getElementById('modulTitle');
            if(modulTitle) modulTitle.innerText = "Menu Utama";
            document.getElementById('qNum').innerText = "-";

            // 7. Balik ke Tampilan Awal (Lobby)
            tampilkanLobby();
        }
    };
	
    window.showResult = function() {
        if(isSubmitted) {
            document.getElementById('resultOverlay').style.display = 'flex';
        } else {
            alert("Belum ada nilai! Silahkan kerjakan dulu soalnya");
        }
    };

    window.toggleRagu = function() {
        if(isSubmitted) return;
        const chk = document.getElementById('checkRagu');
        raguStatus[currentIdx] = chk.checked;
        if (chk.checked) userAnswers[currentIdx] = null;
        updateSidebarStatus();
        loadQuestion(currentIdx);
    };

    window.toggleFocusMode = function() { document.body.classList.toggle('mode-focus'); };

    function updateProgress() {
        let answered = userAnswers.filter(a => a !== null).length;
        let total = currentQuestions.length;
        let txt = document.getElementById('progressText');
        if(txt) txt.innerText = `Menjawab: ${answered} / ${total}`;
    }

    window.saveAndShowChart = async function(finalScore, correct, wrong) {
        // 1. Siapkan Data
        const usedSeconds = totalExamTime - timeRemaining; // Hitung durasi
        const resultData = {
            uid: currentUser.uid,              // ID User
            nama: currentUser.displayName,     // Nama User
            modul: currentModulKey,            // ID Modul
            score: finalScore,
            correct: correct,
            wrong: wrong,
            date: new Date().toLocaleString('id-ID'), 
            timestamp: new Date(),             // Waktu server
            duration: usedSeconds
        };

        try {
            // 2. Kirim ke Firebase (Collection: riwayat_belajar)
            await addDoc(collection(db, "riwayat_belajar"), resultData);
            console.log("Data nilai berhasil disimpan ke Cloud!");
        } catch (e) {
            console.error("Gagal simpan history:", e);
        }
    };

// 1. FUNGSI RESET DATA (HAPUS RIWAYAT)
    window.resetStats = async function() {
        if(!confirm("‚ö†Ô∏è Yakin mau menghapus SEMUA riwayat nilai untuk modul ini? Data di Cloud akan hilang permanen.")) return;
        
        try {
            // Cari data yg mau dihapus (sesuai User & Modul)
            const q = query(collection(db, "riwayat_belajar"), where("uid", "==", currentUser.uid), where("modul", "==", window.currentDatabaseId));
            const querySnapshot = await getDocs(q);
            
            // Hapus rame-rame pake Batch
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            alert("Data berhasil direset!");
            window.openStats(); // Refresh tampilan biar kosong
        } catch (e) {
            console.error("Gagal reset:", e);
            alert("Gagal menghapus data.");
        }
    };

    // 2. FUNGSI BUKA STATISTIK (TARIK DATA DARI CLOUD)
    window.openStats = async function() {
        if(!currentUser) { alert("Login dulu bro!"); return; }
        if(!window.currentDatabaseId) { alert("Pilih modul dulu di samping kiri!"); return; }

        document.getElementById('statsOverlay').style.display = 'flex';
        const wm = document.getElementById('watermark');
        if(wm) wm.style.display = 'none';
        
        document.getElementById('statsTitle').innerText = "Memuat Data Cloud...";
        document.getElementById('statsTableBody').innerHTML = '<tr><td colspan="5">Sedang mengambil data dari server...</td></tr>';

        try {
            // A. AMBIL DATA DARI FIREBASE
            const q = query(collection(db, "riwayat_belajar"), where("uid", "==", currentUser.uid), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            
            let allHistory = [];
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id; 
                allHistory.push(data);
            });

            // B. OLAH DATA KHUSUS MODUL SAAT INI (Grafik Garis)
            const currentModulHistory = allHistory.filter(h => h.modul === window.currentDatabaseId);
            
            // Update Judul
            const judulModul = document.getElementById('modulTitle') ? document.getElementById('modulTitle').innerText : window.currentDatabaseId;
            document.getElementById('statsTitle').innerText = "Data Modul: " + judulModul;

            // Update Tabel
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            if (currentModulHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Belum ada riwayat pengerjaan di modul ini.</td></tr>';
            } else {
                [...currentModulHistory].reverse().forEach((d, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${idx+1}</td><td>${d.date}</td><td style="font-weight:bold; color:${d.score>=70?'green':'red'}">${d.score}</td><td>${d.correct} ‚úÖ</td><td>${d.wrong} ‚ùå</td>`;
                    tbody.appendChild(tr);
                });
            }

            // Render Grafik Garis
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (window.statsChartInstance instanceof Chart) window.statsChartInstance.destroy();
            
            window.statsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentModulHistory.map((_, i) => "Tes " + (i+1)),
                    datasets: [{
                        label: 'Nilai Kamu',
                        data: currentModulHistory.map(d => d.score),
                        borderColor: '#2980b9',
                        backgroundColor: 'rgba(41, 128, 185, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Batas Lulus (70)',
                        data: currentModulHistory.map(() => 70),
                        borderColor: '#c0392b',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: { animation: { duration: 1000 }, responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // C. OLAH DATA SEMUA MODUL (Grafik Batang)
            let modulStats = {};
            allHistory.forEach(h => {
                if(!modulStats[h.modul]) modulStats[h.modul] = { total: 0, count: 0 };
                modulStats[h.modul].total += h.score;
                modulStats[h.modul].count++;
            });

            const labels = [];
            const dataScores = [];
            const backgroundColors = [];
            const colors = ['#e74c3c', '#3498db', '#9b59b6', '#f1c40f', '#2ecc71', '#e67e22', '#1abc9c'];

            Object.keys(modulStats).forEach((key, index) => {
                let niceName = key;
                let btn = document.getElementById('btn-'+key);
                if(btn) niceName = btn.innerText.split(':')[0]; 

                labels.push(niceName);
                dataScores.push(Math.round(modulStats[key].total / modulStats[key].count));
                backgroundColors.push(colors[index % colors.length]);
            });

            const ctxAll = document.getElementById('allModulesChart').getContext('2d');
            if (window.allModulesChartInstance instanceof Chart) window.allModulesChartInstance.destroy();
            
            window.allModulesChartInstance = new Chart(ctxAll, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Rata-rata Nilai', data: dataScores, backgroundColor: backgroundColors, borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
            });

        } catch (e) {
            console.error("Gagal ambil data:", e);
            document.getElementById('statsTableBody').innerHTML = '<tr><td colspan="5">Gagal memuat data. Cek koneksi internet.</td></tr>';
        }
    };

    // 3. FUNGSI TUTUP STATISTIK
    window.closeStats = function() {
        document.getElementById('statsOverlay').style.display = 'none';
        const wm = document.getElementById('watermark');
        if(wm) wm.style.display = 'block';
    };

    function tampilkanLobby() {
        document.querySelector('.question-header').style.visibility = 'hidden';
        document.querySelector('.footer-nav').style.visibility = 'hidden';
        const qText = document.getElementById('questionText');
        qText.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üëà</div>
                <h3 style="color: #2c3e50; margin-bottom: 10px;">Siap Latihan?</h3>
                <p style="font-size: 1.2rem; color: #555;">
                    Silahkan <b>klik salah satu modul</b> di menu samping kiri<br>untuk memulai simulasi ujian.
                </p>
            </div>
        `;
        document.getElementById('optionsContainer').innerHTML = '';
        document.getElementById('feedbackBox').style.display = 'none';
        document.querySelectorAll('.module-item').forEach(el => el.classList.remove('active'));
    }

</script>
</body>
</html>





































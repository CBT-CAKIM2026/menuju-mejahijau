<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="icon" type="image/png" href="PRO-TAMA.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIMULASI CBT CAKIM PA 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- PALET WARNA MAHKAMAH AGUNG --- */
        :root {
            --primary: #004d00;   /* Hijau Botol Tua */
            --secondary: #1a1a1a; /* Hitam Elegan */
            --accent: #2e7d32;    /* Hijau Daun */
            --gold: #d4af37;      /* Emas Mewah */
            --purple: #8e44ad;    /* Ungu (Grafik) */
            --light: #f1f8e9;      
            --filled: #7f8c8d;     
            --success: #2e7d32;     
            --danger: #c0392b;     
            --warning: #f39c12;     
            --pass: #2ecc71;
            --fail: #e74c3c;
        }

        /* --- FLASHCARD MODE --- */
        .mode-hafalan { filter: blur(12px); pointer-events: none; user-select: none; transition: all 0.3s ease; }

        /* --- ANTI CURANG --- */
        body:not(.is-admin) * { -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        body.is-admin * { -webkit-user-select: text !important; -ms-user-select: text !important; user-select: text !important; }
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('ma.jpeg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            display: flex;
            height: 100vh;
            height: 100dvh;
            color: #333;
            overflow: hidden;
            transition: all 0.3s;
        }

        /* LOGIN SCREEN */
        #loginOverlay {
            background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.95)), 
                        url('https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Mahkamah_Agung_Republic_of_Indonesia.jpg/1200px-Mahkamah_Agung_Republic_of_Indonesia.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999;
            overflow-y: auto; overflow-x: hidden; font-family: 'Poppins', sans-serif; color: #333; display: block !important; 
        }

        .landing-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; width: 100%; background-color: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; box-sizing: border-box; border-bottom: 3px solid var(--gold); }
        .nav-brand { font-size: 1.3rem; font-weight: 700; color: #ffffff; display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; }
        .nav-login-btn { background-color: #ffffff; color: var(--primary); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .nav-login-btn:hover { background-color: #f0f0f0; transform: translateY(-1px); }

        .hero-section { display: grid; grid-template-columns: 1.2fr 0.8fr; padding: 40px 60px 10px 60px; max-width: 1300px; margin: 0 auto; min-height: 80vh; box-sizing: border-box; position: relative; }
        .hero-left { display: flex; flex-direction: column; justify-content: center; padding-right: 20px; margin-left: -40px; }
        .hero-quote { font-size: 2.8rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; color: #111; }
        .highlight-text { color: var(--primary); }
        .hero-right { display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-start; padding-bottom: 25px; padding-left: 20px; }
        .hero-features { list-style: none; padding: 0; margin: 0; }
        .hero-features li { font-size: 1rem; color: #444; margin-bottom: 8px; display: flex; align-items: center; gap: 15px; font-weight: 600; }
        .feature-icon { color: var(--primary); font-size: 1.1rem; width: 25px; text-align: center; }
        .dev-footer { grid-column: 1 / -1; font-size: 0.85rem; color: #666; margin-top: 5px; padding-top: 15px; border-top: 1px solid #bbb; font-weight: 600; }

        @media (max-width: 992px) {
            .landing-nav { padding: 10px 15px; gap: 5px; }
            .nav-brand { font-size: 0.9rem; }
            .nav-login-btn { padding: 6px 12px; font-size: 0.75rem; border-radius: 4px; }
            .nav-login-btn img { width: 18px; height: 18px; }
            .hero-section { display: flex; flex-direction: column; padding: 20px 20px; gap: 20px; justify-content: center; min-height: 80vh; }
            .hero-left { margin-left: 0; padding-right: 0; text-align: center; margin-top: 10px; }
            .hero-quote { font-size: 1.6rem; } 
            .hero-right { padding-left: 0; align-items: center; justify-content: center; width: 100%; padding-bottom: 40px; }
            .hero-features li { background: rgba(255,255,255,0.6); padding: 8px 12px; border-radius: 6px; width: 100%; justify-content: flex-start; font-size: 0.85rem; margin-bottom: 5px; }
            .dev-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 0.65rem; padding: 8px 0; margin: 0; background: rgba(255,255,255,0.8); border-top: none; z-index: 101; }
        }

        /* APP STYLES */
        #appSection { display: none; width: 100%; height: 100%; display: flex; background-color: #f4f7f6; position: fixed; top: 0; left: 0; z-index: 10; }
        .sidebar-left { width: 280px; background-color: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100%; flex-shrink: 0; z-index: 10; transition: margin-left 0.3s ease; }
        body.mode-focus .sidebar-left { margin-left: -280px; }
        body.mode-focus #floatingTimer { display: block !important; }

        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #004d00 0%, #002d00 100%); color: white; text-align: center; border-bottom: 4px solid var(--gold); box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .header-app-title { margin-top: 10px; margin-bottom: 15px; }
        .header-app-title h3 { font-family: 'Poppins', sans-serif; font-size: 1.4rem; font-weight: 800; letter-spacing: 1px; margin: 0; line-height: 1.2; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header-app-title span { font-size: 0.8rem; color: var(--gold); font-weight: 600; display: block; margin-top: 5px; letter-spacing: 0.5px; }
        
        .user-profile-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); border-radius: 10px; padding: 10px 15px; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: left; margin-bottom: 15px; }
        .user-avatar-styled { width: 40px; height: 40px; border-radius: 10px; border: 2px solid var(--gold); object-fit: cover; }
        .user-info-text { display: flex; flex-direction: column; overflow: hidden; }
        .user-name-label { font-size: 0.85rem; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        .user-role-label { font-size: 0.7rem; color: rgba(255,255,255,0.8); }

        .timer-container { background: #0e5e2a; color: #ffeb3b; border: 2px solid #fbc02d; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.4rem; letter-spacing: 1px; border-radius: 8px; padding: 6px 0; width: 85%; margin: 12px auto; box-shadow: 0 3px 6px rgba(0,0,0,0.2); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transition: all 0.3s ease; display: block; }
        .timer-green { background: #0e5e2a !important; color: #ffeb3b !important; border-color: #fbc02d !important; }
        .timer-yellow { background: #ffeb3b !important; color: #222 !important; border-color: #f57f17 !important; text-shadow: none; }
        .timer-panic { background: #d32f2f !important; color: #fff !important; border-color: #b71c1c !important; box-shadow: 0 0 10px rgba(211, 47, 47, 0.5) !important; animation: panicPulse 0.5s infinite alternate; }
        @keyframes panicPulse { 0% { transform: scale(1); opacity: 1; border-color: #ff1744; } 100% { transform: scale(1.05); opacity: 0.9; border-color: #ff5252; } }

        .modul-selector { flex: 1; padding: 10px; background: #fff; overflow-y: auto; padding-bottom: 50px; }
        .modul-btn { display: block; width: 100%; padding: 12px 15px; margin-bottom: 8px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; text-align: left; font-size: 0.9rem; font-weight: 600; color: var(--secondary); transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .modul-btn:hover { background: var(--light); transform: translateX(2px); border-color: var(--primary); }
        .modul-btn.active-modul { background: var(--primary); color: white; border-color: var(--primary); border-left: 5px solid var(--gold); }

        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px 40px; overflow-y: auto; background: #f4f7f6; transition: all 0.3s ease; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; width: 100%; margin-bottom: 50px; border-top: 4px solid var(--primary); }

        .sidebar-right { width: 300px; background-color: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; flex-shrink: 0; z-index: 10; }
        .right-header { padding: 15px 12px; background: #ffffff; border-bottom: 1px solid #eee; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-action { border: none; padding: 10px 8px; border-radius: 10px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: white; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.15); width: 100%; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-action i { font-size: 0.95rem; }

        .act-admin { background: linear-gradient(135deg, #34495e, #2c3e50); } 
        .act-rank { background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; } 
        .act-data { background: linear-gradient(135deg, #2ecc71, #27ae60); } 
        .act-nilai { background: linear-gradient(135deg, #9b59b6, #8e44ad); font-weight: 700; }
        .act-exit { background: linear-gradient(135deg, #e74c3c, #c0392b); grid-column: span 2; margin-top: 5px; }

        .sidebar-info { padding: 15px; font-size: 0.8rem; text-align: center; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .nav-container { flex: 1; overflow-y: auto; padding: 15px; background: white; min-height: 0; }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .nav-btn { aspect-ratio: 1; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 6px; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #555; transition: all 0.2s; }
        .nav-btn:hover { background-color: var(--light); }
        .nav-btn.active { border: 2px solid var(--primary); background-color: var(--light); color: var(--primary); box-shadow: 0 0 5px rgba(0, 77, 0, 0.3); transform: scale(1.1); z-index: 2; }
        .nav-btn.filled { background-color: var(--secondary); color: white; border-color: var(--secondary); }
        .nav-btn.correct { background-color: var(--success); color: white; border-color: var(--success); }
        .nav-btn.wrong { background-color: var(--danger); color: white; border-color: var(--danger); }
        .nav-btn.ragu { background-color: var(--warning) !important; color: black !important; border-color: var(--warning) !important; }

        .finish-container { padding: 15px 20px; border-top: 1px solid #eee; background: #f9f9f9; padding-bottom: 50px; margin-top: auto; flex-shrink: 0; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--light); padding-bottom: 15px; }
        .question-text { font-size: 1.2rem; margin-bottom: 30px; line-height: 1.6; font-weight: 500; color: #2c3e50; }
        
        .option-label { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1rem; background: white; margin-bottom: 10px; }
        .option-label:hover { background-color: var(--light); border-color: var(--primary); }
        .option-label.selected { background-color: #e8f5e9; border-color: var(--primary); font-weight: 500; }
        .option-label.review-correct { background-color: #d4edda; border-color: var(--success); color: #155724; }
        .option-label.review-wrong { background-color: #f8d7da; border-color: var(--danger); color: #721c24; }

        .btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; color: white; transition: 0.3s; }
        .btn-prev { background-color: var(--secondary); } 
        .btn-next { background-color: var(--primary); }    
        .btn-finish { background-color: var(--success); width: 100%; }
        .btn-purple { background-color: #8e44ad !important; color: white !important; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .feedback-box { margin-top: 25px; padding: 20px; border-radius: 8px; background-color: #fff3cd; border-left: 5px solid var(--warning); display: none; }
        .feedback-box.show { display: block; }

        .watermark { position: fixed; left: 0; bottom: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); border-top: 1px solid #ddd; text-align: center; padding: 8px 0; color: #666; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; height: 35px; box-sizing: border-box; }
        
        .result-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999999 !important; backdrop-filter: blur(5px); }
        .result-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 800px; max-width: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; padding-bottom: 80px !important; animation: slideUp 0.5s ease-out; border-top: 5px solid var(--primary); position: relative; z-index: 1000000; }
        .score-circle { width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; margin: 20px auto; border: 5px solid var(--gold); box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        .stats-table th { background-color: var(--primary); color: white; }
        .stats-table tr:nth-child(even) { background-color: #f9f9f9; }
        .stats-section-title { text-align: left; margin: 15px 0 5px 0; font-weight: bold; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .footer-nav { margin-top: 40px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 5; }
        .ragu-wrapper { display: flex; align-items: center; gap: 8px; font-weight: bold; color: var(--warning); cursor: pointer; user-select: none; }
        .ragu-wrapper input { width: 18px; height: 18px; cursor: pointer; }
        .focus-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary); margin-right: 15px; }

        #floatingTimer { display: none; position: fixed; top: 50px; left: 30px; z-index: 99999; padding: 10px 25px; border-radius: 8px; font-size: 1.5rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 2px solid white; color: #ffeb3b; background: rgba(0, 77, 0, 0.9); }
        
        /* === TAMPILAN HP FIXED === */
        @media (max-width: 768px) {
            body { padding-bottom: 0 !important; flex-direction: column; overflow: hidden; }
            .sidebar-left { width: 100% !important; height: 100% !important; border-right: none; z-index: 100; position: fixed; top: 0; left: 0; }
            .sidebar-left .timer-container { display: none !important; }
            .modul-selector { max-height: none !important; height: calc(100% - 85px); overflow-y: auto; padding-bottom: 120px !important; }
            .main-content { width: 100% !important; margin: 0 !important; height: calc(100dvh - 120px) !important; flex: 1; overflow-y: scroll !important; -webkit-overflow-scrolling: touch; padding: 15px 15px 0 15px !important; }
            .card::after { content: ""; display: block; height: 200px; width: 100%; }
            .card { margin-bottom: 0 !important; padding: 20px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
            .sidebar-right { display: none; }
            .sidebar-right.show-mobile { display: flex !important; flex-direction: column; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 15000; background: white; padding-top: 50px; margin-right: 0 !important; }
            .nav-grid { grid-template-columns: repeat(6, 1fr) !important; gap: 5px !important; }
            .nav-btn { font-size: 0.75rem !important; aspect-ratio: 1; border-radius: 4px; }
            .finish-container { display: none !important; }
            #floatingTimer { display: none; position: fixed; top: 10px; left: 10px; right: auto; font-size: 13px; padding: 6px 12px; z-index: 99999; border-radius: 20px; }
            .footer-nav { flex-direction: column; gap: 12px; margin-top: 20px; position: relative; z-index: 10; }
            .footer-nav .ragu-wrapper { width: 100%; margin-right: 0; justify-content: center; background: #fff3e0; padding: 10px; border-radius: 8px; }
            .footer-nav > div:last-child { width: 100% !important; display: flex !important; gap: 10px !important; }
            .footer-nav .btn { padding: 12px 15px !important; font-size: 0.9rem !important; width: 50% !important; border-radius: 8px; flex: 1; }
            #mobileFooter { display: none; position: fixed; bottom: 35px; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 8px 15px; z-index: 1001; justify-content: space-between; border-top: 1px solid #eee; gap: 10px; box-sizing: border-box; }
            .close-sidebar-btn { display: block !important; }
            .question-box { font-size: 15px; line-height: 1.5; }
            .option-label { padding: 12px; margin-bottom: 10px; font-size: 0.95rem; }
            .question-header .focus-btn { display: none; } 
            .question-header { flex-direction: column; align-items: flex-start; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            #modulTitle { font-size: 0.95rem !important; line-height: 1.3; font-weight:700; color:var(--primary); }
            #qNum { font-size: 0.85rem !important; font-weight:600; }
            #modeIndicator { font-size: 0.7rem; padding: 2px 8px; align-self: flex-start; margin-top: 5px; }
            body.ujian-berjalan .sidebar-left { display: none; }
            .nav-container { padding-bottom: 150px !important; }
        }

        #mobileFooter { display: none; }
        .mobile-nav-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; flex: 1; border: 1px solid var(--gold); display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; white-space: nowrap; }
        .mobile-nav-btn:active { transform: scale(0.95); opacity: 0.9; }
        .close-sidebar-btn { display: none; width: 100%; padding: 15px; background: var(--danger); color: white; border: none; border-radius: 0; position: absolute; top:0; left:0; font-weight: bold; font-size: 16px; z-index: 10000; }

        @media (min-width: 769px) {
            .ragu-wrapper { flex: 1; background-color: #fdfdfd; padding: 12px 20px; border-radius: 8px; margin-right: 20px; cursor: pointer; }
            .ragu-wrapper:hover { background-color: #fff3e0; border-color: var(--warning); }
            #prevBtn { margin-right: 0 !important; }
            .footer-nav > div:last-child { width: auto !important; gap: 15px !important; }
        }

        /* Sidebar Lobby */
        .stat-box-small { background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-box-small:hover { transform: translateY(-2px); }
        .mini-rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f9f9f9; font-size: 0.8rem; }
        .mini-rank-item:last-child { border-bottom: none; }
        .rank-num { font-weight: bold; width: 20px; color: var(--gold); }
        .rank-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; color: #333; }
        .rank-score { font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div id="gatekeeperOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:1000000; backdrop-filter:blur(15px); align-items:center; justify-content:center; font-family:'Poppins', sans-serif;">
    <div style="background:white; padding:35px; border-radius:20px; width:450px; max-width:92%; text-align:center; border-top:8px solid var(--gold); box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
        
        <div id="gateLoading">
            <i class="fas fa-circle-notch fa-spin" style="font-size:3.5rem; color:var(--primary); margin-bottom:20px;"></i>
            <h3 style="color:var(--primary);">Verifikasi Akses VIP...</h3>
        </div>

        <div id="gateInputArea" style="display:none;">
            <i class="fas fa-envelope-open-text" style="font-size:3.5rem; color:var(--primary); margin-bottom:20px;"></i>
            <h2 style="color:var(--primary); margin:0;">Kode VIP Terkirim!</h2>
            <p style="color:#666; font-size:0.9rem; margin-top:10px;">
                Halo <b id="gateUserName"></b>, cek email <b><span id="gateEmailUser"></span></b> (Inbox/Spam) untuk mendapatkan kode akses unik Anda.
            </p>
            <input type="text" id="inputVipCode" placeholder="CONTOH: PACTA-SUNT-SERVANDA-123" style="width:100%; padding:18px; margin:20px 0; border:2px solid #eee; border-radius:12px; text-align:center; font-weight:800; letter-spacing:1px; font-size:1rem; box-sizing:border-box; color:var(--primary); text-transform:uppercase;">
            <div id="vipError" style="color:var(--danger); font-size:0.85rem; margin-bottom:15px; display:none; font-weight:600;">‚ö†Ô∏è Kode tidak sesuai untuk email Anda!</div>
            <button onclick="verifyVipCode()" id="btnVerifyVip" style="width:100%; background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1.1rem;">BUKA AKSES SEKARANG</button>
            <button onclick="handleLogout()" style="background:none; border:none; color:#999; margin-top:20px; cursor:pointer; font-size:0.85rem; text-decoration:underline;">Keluar / Ganti Akun</button>
        </div>
    </div>
</div>

    <div id="maintenanceOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000000; text-align:center; padding-top:100px; font-family:'Poppins', sans-serif;">
        <i class="fas fa-tools" style="font-size:5rem; color:var(--gold); margin-bottom:20px;"></i>
        <h1 style="color:var(--primary);">Sistem Sedang Maintenance</h1>
        <p style="font-size:1.2rem; color:#666;">Mohon maaf, sedang ada update soal.<br>Mohon ditunggu, bakal balik lagi secepatnya!</p>
        <div style="margin-top:30px; font-weight:bold; color:var(--gold);">PRO-TAMA (CBT CAKIM PA 2026)</div>
    </div>

    <div id="floatingTimer">00:00:00</div>
    
    <div id="mobileFooter">
        <button class="mobile-nav-btn" onclick="toggleMobileModul()"><i class="fas fa-book"></i> Daftar Modul</button>
        <button class="mobile-nav-btn" onclick="toggleMobileSidebar()"><i class="fas fa-th"></i> Daftar Soal</button>
    </div>

<div id="loginOverlay">
    <nav class="landing-nav">
        <div class="nav-brand" style="display: flex; align-items: center; gap: 10px;">
            <img src="PRO-TAMA.png" alt="Logo" style="height: 40px; width: auto;">
            PRO-TAMA (CBT CAKIM PA 2026)
        </div>
        <button class="nav-login-btn" onclick="handleLogin()">
            <img src="https://img.icons8.com/color/48/google-logo.png" width="25" height="25" alt="G">
            <span>Masuk dengan Google</span>
        </button>
    </nav>
    <section class="hero-section">
        <div class="hero-left">
            <h1 class="hero-quote">
                Belajar Hari Ini,<br>
                <span class="highlight-text">Dipercaya Esok Hari.</span><br>
                Ilmu Mengangkat Derajat,<br>
                <span class="highlight-text">Integritas Menjaga Kehormatan.</span>
            </h1>
        </div>
        <div class="hero-right">
            <ul class="hero-features">
                <li><i class="fas fa-database feature-icon"></i> <span>Soal Terlengkap</span></li>
                <li><i class="fas fa-chart-line feature-icon"></i> <span>Database & Peringkat Real-time</span></li>
                <li><i class="fas fa-gavel feature-icon"></i> <span>Pembahasan Hukum</span></li>
                <li><i class="fas fa-brain feature-icon"></i> <span>Mode Hafalan (Active Recall)</span></li>
                <li><i class="fas fa-volume-up feature-icon"></i> <span>Audio Pembahasan Otomatis</span></li>
                <li><i class="fas fa-mobile-alt feature-icon"></i> <span>Akses Fleksibel (Laptop & HP)</span></li>
            </ul>
        </div>
        <div id="loginError" style="color: #c0392b; font-size: 0.9rem; position:absolute; top:80px; right:60px;"></div>
        <div class="dev-footer">Developed by Ilham Nur Pratama - APP 2023 - PA SERANG</div>
    </section>
</div>
    
    <div id="appSection" style="display:none;">
        <div class="watermark" id="watermark">Developed by Ilham Nur Pratama - APP 23 - PA Serang</div>
         <div class="sidebar-left">
            <div class="sidebar-header">
            <img src="PRO-TAMA.png" alt="Logo" style="height: 55px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">

            <div class="header-app-title">
                <h3>PRO-TAMA</h3>
                <span>CBT CAKIM PA 2026</span>
            </div>

            <div class="user-profile-card">
                <img id="userAvatar" src="" class="user-avatar-styled" alt="User">
                <div class="user-info-text">
                    <span id="roleDisplay" class="user-name-label">Memuat Nama...</span>
                    <span class="user-role-label"><i class="fas fa-user-shield"></i> Peserta Ujian</span>
                </div>
            </div>

            <div class="timer-pill" id="timerDisplay">00:00:00</div>
        </div>
        
            <div style="display: flex; gap: 5px; padding: 10px; background: #eee; border-bottom: 1px solid #ddd;">
                <button onclick="switchCategory('hukum')" id="btnTabHukum" style="flex:1; padding:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; background:var(--primary); color:white; transition: 0.3s;">
                    <i class="fas fa-gavel"></i> HUKUM
                </button>
                <button onclick="switchCategory('psikotes')" id="btnTabPsikotes" style="flex:1; padding:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; background:#ccc; color:#333; transition: 0.3s;">
                    <i class="fas fa-brain"></i> PSIKOTES
                </button>
            </div>
        
            <div class="modul-selector">
                <div id="group-hukum">
                    <small style="color: #666; display:block; margin-bottom:10px; font-weight:bold;">Materi Hukum & Peradilan:</small>
                    <button class="modul-btn active-modul" id="btn-modul1" onclick="switchDatabase('modul1')">Modul 1: Kekuasaan Kehakiman</button>
                    <button class="modul-btn" id="btn-modul2" onclick="switchDatabase('modul2')">Modul 2: Mahkamah Agung</button>
                    <button class="modul-btn" id="btn-modul3" onclick="switchDatabase('modul3')">Modul 3: Peradilan Agama</button>
                    <button class="modul-btn" id="btn-modul4" onclick="switchDatabase('modul4')">Modul 4: Pendaftaran & Relaas</button>
                    <button class="modul-btn" id="btn-modul5" onclick="switchDatabase('modul5')">Modul 5: Gugatan & Permohonan</button>
                    <button class="modul-btn" id="btn-modul6" onclick="switchDatabase('modul6')">Modul 6: PMH & Wanprestasi</button>
                    <button class="modul-btn" id="btn-modul7" onclick="switchDatabase('modul7')">Modul 7: Mediasi</button>
                    <button class="modul-btn" id="btn-modul8" onclick="switchDatabase('modul8')">Modul 8: Perkawinan (KHI)</button>
                    <button class="modul-btn" id="btn-modul8.1" onclick="switchDatabase('modul8.1')">Modul 8.1: Perkawinan (Lanjutan)</button>
                    <button class="modul-btn" id="btn-modul8.2" onclick="switchDatabase('modul8.2')">Modul 8.2: Perkawinan (Akhir)</button>
                    <button class="modul-btn" id="btn-modul8.3" onclick="switchDatabase('modul8.3')">Modul 8.3: Perkawinan (UU 1/1974)</button>
                    <button class="modul-btn" id="btn-modul8.4" onclick="switchDatabase('modul8.4')">Modul 8.4: Pelaksana (PP 9/1975)</button>
                    <button class="modul-btn" id="btn-modul9" onclick="switchDatabase('modul9')">Modul 9: Perwalian & Pengangkatan</button>
                    <button class="modul-btn" id="btn-modul10" onclick="switchDatabase('modul10')">Modul 10: Waris Islam (Dasar)</button>
                    <button class="modul-btn" id="btn-modul10.1" onclick="switchDatabase('modul10.1')">Modul 10.1: Waris (KHI)</button>
                    <button class="modul-btn" id="btn-modul10.2" onclick="switchDatabase('modul10.2')">Modul 10.2: Waris (BW)</button>
                    <button class="modul-btn" id="btn-modul10.3" onclick="switchDatabase('modul10.3')">Modul 10.3: Studi Kasus Waris</button>
                    <button class="modul-btn" id="btn-modul11" onclick="switchDatabase('modul11')">Modul 11: Wasiat & Hibah</button>
                    <button class="modul-btn" id="btn-modul12" onclick="switchDatabase('modul12')">Modul 12: Sita Jaminan</button> 
                    <button class="modul-btn" id="btn-modul13" onclick="switchDatabase('modul13')">Modul 13: Ekonomi Syariah A</button>
                    <button class="modul-btn" id="btn-modul13.1" onclick="switchDatabase('modul13.1')">Modul 13.1: Akad Syariah</button>
                    <button class="modul-btn" id="btn-modul13.2" onclick="switchDatabase('modul13.2')">Modul 13.2: Ekonomi Syariah B</button>
                    <button class="modul-btn" id="btn-modul14" onclick="switchDatabase('modul14')">Modul 14: Perwakafan</button>
                    <button class="modul-btn" id="btn-modul15" onclick="switchDatabase('modul15')">Modul 15: Buku Saku PA A</button>
                    <button class="modul-btn" id="btn-modul15.1" onclick="switchDatabase('modul15.1')">Modul 15.1: Buku Saku PA B</button>
                    <button class="modul-btn" id="btn-modul15.2" onclick="switchDatabase('modul15.2')">Modul 15.2: Buku Saku PA C</button>
                    <button class="modul-btn" id="btn-modul16" onclick="switchDatabase('modul16')">Modul 16: Prodeo & Posbakum</button>
                    <button class="modul-btn" id="btn-modul17" onclick="switchDatabase('modul17')">Modul 17: E-Court, E-Litigasi & Surat Tercatat</button>
                </div>
        
                <div id="group-psikotes" style="display: none;">
                    <small style="color: #666; display:block; margin-bottom:10px; font-weight:bold;">Tes Kepribadian & TPA:</small>
                    <button class="modul-btn" id="btn-modul18" onclick="switchDatabase('modul18')">Modul 18: PAPI Kostick</button>
                    <button class="modul-btn" id="btn-modul19" onclick="switchDatabase('modul19')">Modul 19: TPA Verbal</button>
                    <button class="modul-btn" id="btn-modul19.1" onclick="switchDatabase('modul19.1')">Modul 19.1: TPA Numerik</button>
                    <button class="modul-btn" id="btn-modul19.2" onclick="switchDatabase('modul19.2')">Modul 19.2: TPA Kuant&Tekn</button>
                    <button class="modul-btn" id="btn-modul19.3" onclick="switchDatabase('modul19.3')">Modul 19.3: TPA Daya Ingat</button>
                    <button class="modul-btn" id="btn-modul19.4" onclick="switchDatabase('modul19.4')">Modul 19.4: TPA Figural</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="question-header">
                    <div style="display:flex; align-items:center;">
                        <button class="focus-btn" onclick="toggleFocusMode()" title="Mode Fokus">‚ò∞</button>
                        <button onclick="toggleHafalan()" id="btnFlashHafalan" style="background:none; border:none; color: var(--secondary); margin-right:15px; cursor:pointer; font-size:1.3rem; transition:0.3s;" title="Mode Hafalan">
                            <i class="fas fa-brain"></i>
                        </button>
                        <div>
                            <span style="font-size: 1.2rem; font-weight: bold; color: var(--secondary); display:block;" id="modulTitle">Modul 1</span>
                            <span style="font-size: 1rem; color: #7f8c8d;">Soal No. <span id="qNum" style="font-weight:bold; color:var(--primary);">1</span></span>
                        </div>
                    </div>
                    <span id="modeIndicator" style="color: var(--warning); font-weight: bold; background:#fff3e0; padding:5px 15px; border-radius:20px; border:1px solid #ffe0b2;">Mode: Ujian</span>
                </div>

                <div id="questionText" class="question-text"></div>
                <div id="optionsContainer" style="display:flex; flex-direction:column; gap:10px;"></div>

                <div id="feedbackBox" class="feedback-box">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin-top:0;">Pembahasan</h3>
                        <button onclick="toggleSpeech()" id="btnSpeak" style="background:none; border:none; cursor:pointer; font-size:1.3rem; color:var(--primary);" title="Dengarkan Pembahasan">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    <p id="feedbackText"></p>
                    <span id="feedbackCite" style="display:block; margin-top:10px; font-style:italic; font-weight:bold; color:#555;"></span>
                </div>

                <div class="footer-nav">
                    <div class="ragu-wrapper">
                        <input type="checkbox" id="checkRagu" onchange="toggleRagu()">
                        <label for="checkRagu">Ragu-Ragu</label>
                    </div>

                    <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                        <button class="btn btn-prev" id="prevBtn" onclick="changeQuestion(-1)" style="margin-right: auto;">‚ùÆ Sebelumnya</button>
                        <button class="btn btn-next" id="nextBtn" onclick="changeQuestion(1)">Selanjutnya ‚ùØ</button>
                    </div>
                </div>
            </div>
        </div>

<div class="sidebar-right">
    
    <div id="lobbySidebarContent" style="padding: 20px; display: flex; flex-direction: column; height: 100%; gap: 15px; overflow-y: auto;">
        
        <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #eee; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative;">
            <h5 style="margin: 0 0 10px 0; color: #555; font-size: 0.9rem;">Rata-Rata Nilai Kamu</h5>
            
            <div style="position: relative; height: 130px; width: 100%; display: flex; justify-content: center;">
                <canvas id="lobbyMiniChart"></canvas>
                <div id="avgScoreText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); font-size: 1.8rem; font-weight: 800; color: var(--primary);">
                    0
                </div>
            </div>
            <span style="font-size: 0.7rem; color: #999;">Dari seluruh modul yang dikerjakan</span>
        </div>

        <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <h5 style="margin: 0 0 10px 0; color: #555; font-size: 0.9rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">
                <i class="fas fa-crown" style="color: var(--gold);"></i> Top 3 
            </h5>
            <div id="miniLeaderboardList" style="font-size: 0.85rem;">
                <p style="color:#ccc; text-align:center;">Memuat data...</p>
            </div>
        <button onclick="openLeaderboard('global')" style="width:100%; margin-top:10px; background:none; border:none; color:var(--primary); font-size:0.75rem; cursor:pointer; font-weight:bold;">
            Lihat Selengkapnya >
        </button>
        </div>

        <div style="margin-top: auto; padding-bottom: 60px;">
             <button class="btn" onclick="openStats()" style="width: 100%; margin-bottom: 10px; background: var(--purple); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <i class="fas fa-chart-pie"></i> Detail Statistik
             </button>
             <button class="btn" onclick="handleLogout()" style="width: 100%; background: var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <i class="fas fa-sign-out-alt"></i> Keluar
             </button>
        </div>
    </div>

    <div id="examSidebarContent" style="display: none; flex-direction: column; height: 100%;">
        <div class="right-header">
            <button class="btn-action act-admin" id="btnAdminPanel" onclick="openAdminPanel()" style="display:none;">
                <i class="fas fa-cogs"></i> Admin
            </button>

            <button class="btn-action act-rank" onclick="openLeaderboard()">
                <i class="fas fa-trophy"></i> Peringkat
            </button>
            
            <button class="btn-action act-data" onclick="openStats()">
                <i class="fas fa-chart-bar"></i> Data
            </button>

             <button class="btn-action act-nilai" id="btnShowScore" onclick="showResult()" style="display:none;">
                <i class="fas fa-award"></i> Nilai
            </button>
            
            <button class="btn-action act-exit" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </div>

        <div class="sidebar-info">
            <div id="progressText" style="font-weight:bold; margin-bottom:10px; color:var(--primary);">Menjawab: 0/0</div>
            <div style="display:flex; justify-content:center; gap:15px;">
                <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:#1e3799; border-radius:2px;"></span> Isi</div>
                <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:var(--warning); border-radius:2px;"></span> Ragu</div>
                <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:white; border:1px solid #ccc; border-radius:2px;"></span> Kosong</div>
            </div>
        </div>

        <div class="nav-container">
            <div class="nav-grid" id="navGrid"></div>
        </div>

        <div class="finish-container"> 
            <button class="btn btn-finish" onclick="confirmFinish()">Selesai Ujian</button>
        </div>
    </div>

    <div id="resultOverlay" class="result-overlay">
        <div class="result-box" style="width:400px;">
            <h2>Hasil Ujian</h2>
            <p id="passStatus" style="font-size:1.5rem; font-weight:bold; margin:5px 0;"></p>
            <p>Skor Akhir:</p>
            <div class="score-circle" id="finalScore">0</div>
            <p id="resultMsg" style="font-weight:500; color:#555;"></p>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button onclick="startReviewWrong()" id="btnReviewWrong" style="width:100%; display:none; margin-bottom:10px; background-color: #d32f2f; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-search-minus"></i> Review Jawaban Salah
                </button>
                
                <button class="btn btn-next" onclick="closeResult()" style="width:100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-book-open"></i> Lihat Pembahasan
                </button>
                
                <button onclick="closeResult(); openLeaderboard();" style="width:100%; background: #00bcd4; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-users"></i> Lihat Peringkat Teman
                </button>
                
                <button class="btn btn-purple" onclick="closeResult(); openStats();" style="width:100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-chart-line"></i> Lihat Grafik Lengkap
                </button>
                
                <button class="btn" onclick="backToMenu()" style="width:100%; background:var(--filled); margin-top:5px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-home"></i> Kembali ke Menu Utama
                </button>
            </div>
        </div>
    </div>

    <div id="leaderboardOverlay" class="result-overlay">
        <div class="result-box" style="width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">üèÜ Top Skor - <span id="lbModulName">Modul Ini</span></h2>
                <button onclick="closeLeaderboard()" style="background:none; border:none; font-size:2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="stats-table">
                    <thead><tr><th style="width:10%">#</th><th>Nama</th><th style="width:20%">Skor</th><th style="width:25%">Waktu</th></tr></thead>
                    <tbody id="leaderboardBody"><tr><td colspan="4">Memuat data...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statsOverlay" class="result-overlay">
        <div class="result-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Statistik Belajar</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="resetStats()" style="background-color:var(--warning); border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; color:white; font-size:0.8rem;">üîÑ Reset Data Modul Ini</button>
                    <button onclick="closeStats()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--danger);">&times;</button>
                </div>
            </div>
            <h4 id="statsTitle" class="stats-section-title">Data Modul Ini: -</h4>
            <div style="width: 100%; height: 200px; margin-bottom: 20px;"><canvas id="statsChart"></canvas></div>
            <div style="max-height: 150px; overflow-y: auto; margin-bottom:20px;">
                <table class="stats-table">
                    <thead><tr><th>No</th><th>Modul</th><th>Nilai</th><th>Percobaan</th><th>Ket</th></tr></thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
            <h4 class="stats-section-title">üèÜ Peta Kekuatan</h4>
            <div style="width: 100%; height: 250px; margin-bottom: 20px;"><canvas id="allModulesChart"></canvas></div>
            <div style="margin-top:20px;"><button class="btn" onclick="closeStats()" style="width:100%; background-color: var(--danger);">Tutup</button></div>
        </div>
    </div>

    <div id="adminOverlay" class="result-overlay">
        <div class="result-box" style="width: 800px; text-align: left; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                <h2 style="margin:0;">‚öôÔ∏è Panel Admin CBT</h2>
                <button onclick="document.getElementById('adminOverlay').style.display='none'" style="background:none; border:none; font-size:2rem; cursor:pointer;">&times;</button>
            </div>

            <div style="background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: #e67e22;"><i class="fas fa-exclamation-triangle"></i> Kontrol Akses Pengguna</strong>
                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Aktifkan untuk mengunci aplikasi bagi pengguna umum.</p>
                </div>
                <button id="btnToggleMaintenance" onclick="toggleMaintenanceStatus()" class="btn-small" style="background: var(--secondary); min-width: 150px;">
                    Memuat Status...
                </button>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="switchAdminTab('tambah')" class="btn-small" style="background:var(--primary); font-size:1rem;">‚ûï Tambah Baru (JSON)</button>
                <button onclick="switchAdminTab('edit')" class="btn-small" style="background:var(--warning); color:black; font-size:1rem;">‚úèÔ∏è Edit / Revisi</button>
                <button onclick="switchAdminTab('review')" class="btn-small" style="background:#8e44ad; font-size:1rem;">üìñ Review Pembahasan</button>
            </div>

            <div id="tabTambah">
                <label style="font-weight:bold;">Target Modul (ID):</label>
                <input type="text" id="adminModulTarget" placeholder="contoh: modul1" style="width:100%; padding:8px; margin-bottom:10px;">
                
                <label style="font-weight:bold;">Paste JSON Soal Disini:</label>
                <textarea id="jsonUploadArea" style="width:100%; height:200px; font-family:monospace; padding:10px; border:1px solid #ccc;" placeholder='[{"q": "Pertanyaan...", "options": ["A","B"], "answer": 0, "explanation": "..."}]'></textarea>
                
                <button onclick="eksekusiUpload()" class="btn" style="background:var(--success); width:100%; margin-top:10px;">üöÄ UPLOAD KE FIREBASE</button>
            </div>

            <div id="tabEdit" style="display:none;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="editModulTarget" placeholder="Nama Modul (cth: modul1)" style="flex:1; padding:8px;">
                    <button onclick="loadSoalAdmin()" class="btn-small" style="background:var(--primary);">üîç Load Soal</button>
                </div>
                
                <div style="display:flex; gap:20px; height: 400px;">
                    <div id="listSoalAdmin" style="flex:1; border:1px solid #ddd; overflow-y:scroll; background:#f9f9f9;">
                        <p style="padding:10px; color:gray;">Klik Load Soal dulu...</p>
                    </div>
                    
                    <div style="flex:1.5; display:flex; flex-direction:column; gap:8px; overflow-y:auto;">
                        <input type="hidden" id="editDocId">
                        <label>Pertanyaan:</label>
                        <textarea id="editQ" rows="3" style="width:95%;"></textarea>
                        
                        <label>Opsi (Pisahkan dengan koma):</label>
                        <textarea id="editOpt" rows="2" style="width:95%;" placeholder="Ayam,Kucing,Bebek"></textarea>
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1">
                                <label>Indeks Jawaban (0=A, 1=B):</label>
                                <input type="number" id="editAns" style="width:100%;">
                            </div>
                        </div>

                        <label>Pembahasan:</label>
                        <textarea id="editExp" rows="3" style="width:95%;"></textarea>
                        
                        <label>Sumber (Cite):</label>
                        <input type="text" id="editCite" style="width:95%;">

                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button onclick="simpanPerubahan()" class="btn" style="background:var(--success); flex:1;">üíæ Update</button>
                            <button onclick="hapusSoal()" class="btn" style="background:var(--danger); flex:1;">üóëÔ∏è Hapus</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tabReview" style="display:none;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="reviewModulTarget" placeholder="ID Modul (cth: modul1)" style="flex:1; padding:8px;">
                    <button onclick="loadReviewPembahasan()" class="btn-small" style="background:var(--primary);">Cek Semua Pembahasan</button>
                </div>
                <div id="containerReview" style="max-height:500px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#fff;">
                    <p style="color:gray;">Pilih modul untuk review pembahasan...</p>
                </div>
            </div>

        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut,  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, deleteDoc, writeBatch, doc, getDoc, updateDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAC4Tskg8XC1N0a13xcsV3A1Mq_8mDnY-A",
        authDomain: "simulasi-cbt-cakim-2026.firebaseapp.com",
        projectId: "simulasi-cbt-cakim-2026",
        storageBucket: "simulasi-cbt-cakim-2026.firebasestorage.app",
        messagingSenderId: "209182753461",
        appId: "1:209182753461:web:1aa2201fa7c73e581234fc",
        measurementId: "G-NDNKMSMWV2"
    };

    // --- EMAIL ADMIN (GANTI DENGAN EMAIL LO) ---
    const ADMIN_EMAIL = "ilhamnp22@gmail.com"; 

    let db, auth, provider, currentUser;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        window.db = db;
        provider = new GoogleAuthProvider();
    }

    window.handleLogin = async () => {
        if(!auth) { alert("Konfigurasi Firebase belum dipasang!"); return; }
        try { await signInWithPopup(auth, provider); } 
        catch (error) { document.getElementById('loginError').innerText = error.message; }
    };

    window.handleLogout = () => { if(auth) signOut(auth).then(() => location.reload()); };

// --- 1. DAFTAR KODE UNIK (TARUH DI LUAR if(auth)) ---
const legalTerms = [
    "PACTA-SUNT-SERVANDA", "IUS-CURIA-NOVIT", "LEX-SPECIALIS", "AUDI-ALTERAM-PARTEM", "ULTIMUM-REMEDIUM", "FIKSI-HUKUM", 
    "LEGAL-STANDING", "DUE-PROCESS", "EQUITY-BEFORE-LAW", "RESTORATIVE-JUSTICE", "CONTEMPT-OF-COURT", "EX-AEQUO-ET-BONO",
    "PRO-BONO", "HAK-IMUNITAS", "PRADUGA-TAK-BERSALAH", "EQUALITY-BEFORE-THE-LAW", "DUE-PROCESS-OF-LAW", "RESTITUTIO-IN-INTEGRUM", 
    "SALUS-POPULI-SUPREMA-LEX", "LEX-POSTERIORI", "LEX-SUPERIOR", "UBI-SOCIETAS-IBI-IUS", "NULLUM-DELICTUM", "IN-DUBIO-PRO-REO", 
    "NE-BIS-IN-IDEM", "ACTUS-REUS", "MENS-REA", "AD-MALA-RES-PULSA", "BONA-FIDES", "UNJUST-ENRICHMENT", "NON-DEROGABLE-RIGHTS", 
    "VERBA-VOLANT", "AL-ADALAH", "AL-MUSAWWAH", "AL-AMANAH", "AL-HURIYYAH", "AS-SHULHU-SAYYIDUL-AHKAM", "AL-YAQINU-LA-YUZALU", 
    "AL-UMURU-BIMAQASHIDIHA", "AL-ADATU-MUHAKKAMAH", "SUMMUM-IUS", "COGITATIONIS-POENAM", "EI-INCUMBIT-PROBATIO", 
    "FACTA-SUNT-POTENTIORA", "IGNORANTIA-EXCUSAT", "INDEX-ANIMI-SERMO", "IUSTITIA-EST-CONSTANS", "LEX-DIVINA", 
    "NEMO-JUDEX", "SIMILIA-SIMILIBUS", "TESTIMONIUM-DE-AUDITU"
];

if(auth) {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const gateOverlay = document.getElementById('gatekeeperOverlay');

            // ============================================================
            // 1. FITUR MAINTENACE
            // ============================================================
            if (typeof watchMaintenance === 'function') {
                watchMaintenance(); 
            }

            // ============================================================
            // 2. FITUR ADMIN (HANYA BUKA PRIVILEGES, TAPI TETAP DICEGAT)
            // ============================================================
            if (user.email === ADMIN_EMAIL) {
                // Tetap kasih 'is-admin' supaya lo BISA COPY-PASTE & KLIK KANAN
                document.body.classList.add('is-admin'); 
                console.log("Welcome Admin! Anti-Cheat Disabled (VIP Check Active).");
                
                const btnAdmin = document.getElementById('btnAdminPanel');
                if(btnAdmin) btnAdmin.style.display = 'flex'; 

                // ‚ùå DULU: Langsung masuk (Bypass)
                // lanjutKeAplikasi(); 
                // return; 

                // ‚úÖ SEKARANG: Dibiarkan lanjut ke bawah supaya kena cek Gatekeeper
            } else {
                document.body.classList.remove('is-admin');
            }

            // ============================================================
            // 3. FITUR GATEKEEPER (PINTU VIP UNTUK SEMUA)
            // ============================================================
            
            // Sembunyikan Login, Tampilkan Loading Gatekeeper
            document.getElementById('loginOverlay').style.setProperty('display', 'none', 'important');
            if(gateOverlay) gateOverlay.style.display = 'flex';
            document.getElementById('gateLoading').style.display = 'block';
            document.getElementById('gateInputArea').style.display = 'none';

            try {
                const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const accessRef = doc(db, "vip_access", user.email);
                const accessSnap = await getDoc(accessRef);

                if (accessSnap.exists()) {
                    if (accessSnap.data().isVerified === true) {
                        // SUDAH VERIFIKASI -> MASUK
                        lanjutKeAplikasi();
                    } else {
                        // BELUM VERIFIKASI -> TAMPILKAN INPUT
                        showGateInput(user.displayName, user.email);
                    }
                } else {
                    // USER BARU (TERMASUK ADMIN PERTAMA KALI) -> GENERATE KODE
                    const randomAsas = legalTerms[Math.floor(Math.random() * legalTerms.length)];
                    const randomNum = Math.floor(100 + Math.random() * 899);
                    const finalCode = `${randomAsas}-${randomNum}`;

                    await setDoc(accessRef, {
                        name: user.displayName,
                        email: user.email,
                        code: finalCode,
                        isVerified: false,
                        createdAt: new Date()
                    });

                    fetch("https://script.google.com/macros/s/AKfycbzO18J1LzCVpqetirC52C-VkbTFBt0s3SwpPY3dAOno2oIYwA2hZHyGlUdyXsCwcxIMQg/exec", {
                        method: "POST",
                        mode: "no-cors",
                        body: JSON.stringify({
                            user_name: user.displayName,
                            user_email: user.email,
                            vip_code: finalCode
                        })
                    }).then(() => {
                        showGateInput(user.displayName, user.email);
                    }).catch(err => {
                        console.error("Gagal kirim email:", err);
                        showGateInput(user.displayName, user.email);
                    });
                }
            } catch (e) { 
                console.error("Gate Error:", e);
                alert("Database Error: " + e.message);
            }

        } else {
            // STATE LOGOUT
            document.body.classList.remove('is-admin');
            document.getElementById('loginOverlay').style.setProperty('display', 'block', 'important');
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('floatingTimer').style.display = 'none';
            document.getElementById('mobileFooter').style.display = 'none';
            if(document.getElementById('gatekeeperOverlay')) document.getElementById('gatekeeperOverlay').style.display = 'none';
        }
    });
}

    // --- FUNGSI PEMBANTU (SUPAYA KODINGAN LEBIH RAPI & AMAN) ---
    // Fungsi ini dipanggil kalau user: 1. Admin, atau 2. Sudah Verifikasi Kode
    function lanjutKeAplikasi() {
        // Matikan semua overlay
        document.getElementById('loginOverlay').style.setProperty('display', 'none', 'important');
        const gate = document.getElementById('gatekeeperOverlay');
        if(gate) gate.style.display = 'none';
    
        // Buka Dashboard Utama
        document.getElementById('appSection').style.display = 'flex';
        
        // Panggil Logic Lobby & Data User (SESUAI PERMINTAAN LO)
        tampilkanLobby();
        
        // Update Nama & Avatar
        let namaPendek = currentUser.displayName.split(" ")[0]; 
        document.getElementById('roleDisplay').innerText = currentUser.displayName; 
        document.getElementById('userAvatar').src = currentUser.photoURL;
    
        // Set Role Label
        const roleLabel = document.querySelector('.user-role-label');
        if (currentUser.email === ADMIN_EMAIL) {
            if(roleLabel) roleLabel.innerHTML = '<i class="fas fa-user-shield" style="color:#ffd700;"></i> Administrator';
        } else {
            if(roleLabel) roleLabel.innerHTML = '<i class="fas fa-user-tie"></i> Peserta Ujian';
        }
    
        // Sembunyikan elemen ujian saat di lobby
        document.getElementById('floatingTimer').style.display = 'none';
        document.getElementById('mobileFooter').style.display = 'none'; 
    
        // Load Data Statistik Lobby
        setTimeout(() => { 
            if(typeof window.loadLobbyData === 'function') window.loadLobbyData(); 
        }, 1000);
    }
    
    // Fungsi Tampilkan Form Input Kode
    function showGateInput(name, email) {
        document.getElementById('gateLoading').style.display = 'none';
        document.getElementById('gateInputArea').style.display = 'block';
        document.getElementById('gateUserName').innerText = name.split(" ")[0];
        document.getElementById('gateEmailUser').innerText = email;
    }
    
    // Fungsi Verifikasi Tombol (Dipanggil via onclick HTML)
    window.verifyVipCode = async () => {
        const input = document.getElementById('inputVipCode').value.trim().toUpperCase();
        const btn = document.getElementById('btnVerifyVip');
        
        if(!input) return alert("Masukkan kode dulu bro!");
    
        btn.innerText = "Memverifikasi...";
        btn.disabled = true;
    
        try {
            const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const accessRef = doc(db, "vip_access", currentUser.email);
            const accessSnap = await getDoc(accessRef);
    
            if (accessSnap.exists() && accessSnap.data().code === input) {
                // Update Status Jadi Verified
                await updateDoc(accessRef, { isVerified: true, verifiedAt: new Date() });
                
                alert("‚úÖ Akses VIP Terbuka! Selamat Belajar.");
                // Masuk Aplikasi Tanpa Reload (Biar Smooth)
                lanjutKeAplikasi();
            } else {
                document.getElementById('vipError').style.display = 'block';
                btn.innerText = "BUKA AKSES SEKARANG";
                btn.disabled = false;
            }
        } catch (e) { 
            alert("Error verifikasi: " + e.message); 
            btn.disabled = false; 
        }
    };

   // ==========================================
// üî• MESIN MAINTENANCE (JANGAN HAPUS) üî•
// ==========================================
// 1. Fungsi Pemantau Status (Dipanggil saat Login)
function watchMaintenance() {
    if (!db) return;
    const { doc, onSnapshot } = window._firebaseUtils || {}; // Fallback safe
    // Kita pakai import manual di dalam atau asumsi db global sudah ready
    // Karena ini module, kita pakai db global yang sudah di-init di atas
    
    try {
        const docRef = doc(db, "settings", "app_status");
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const isMaintenance = docSnap.data().maintenance;
                const btn = document.getElementById('btnToggleMaintenance');
                const overlay = document.getElementById('maintenanceOverlay');

                // Update Tombol Admin
                if (btn) {
                    if (isMaintenance) {
                        btn.innerHTML = '<i class="fas fa-lock"></i> Maintenance: ON';
                        btn.style.background = "#c0392b"; 
                    } else {
                        btn.innerHTML = '<i class="fas fa-lock-open"></i> Maintenance: OFF';
                        btn.style.background = "#2e7d32"; 
                    }
                }

                // Kunci Layar User Biasa
                if (isMaintenance && currentUser?.email !== ADMIN_EMAIL) {
                    if (overlay) overlay.style.display = 'block';
                } else {
                    if (overlay) overlay.style.display = 'none';
                }
            }
        });
    } catch (e) {
        console.log("Maintenance watcher init error (ignore if logged out):", e);
    }
}

// 2. Fungsi Tombol Admin (Toggle ON/OFF)
window.toggleMaintenanceStatus = async () => {
    try {
        const { doc, getDoc, updateDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const statusRef = doc(db, "settings", "app_status");
        const docSnap = await getDoc(statusRef);
        
        if (docSnap.exists()) {
            const currentStatus = docSnap.data().maintenance;
            await updateDoc(statusRef, {
                maintenance: !currentStatus,
                lastUpdated: new Date(),
                updatedBy: currentUser.displayName
            });
        } else {
            await setDoc(statusRef, { maintenance: true });
            alert("Status Maintenance dibuat: AKTIF");
        }
    } catch (e) {
        alert("Gagal mengubah status: " + e.message);
    }
};
// ==========================================
    window.saveScoreToCloud = async (modulId, skor) => {
        if (!currentUser || !db) return;
        try {
            await addDoc(collection(db, "leaderboard"), {
                uid: currentUser.uid, nama: currentUser.displayName, modul: modulId, skor: skor, tanggal: new Date()
            });
        } catch (e) { console.error("Gagal simpan skor:", e); }
    };

    window.savePapiToCloud = async (status, totalFail, detail) => {
        if(!auth.currentUser) return;
        try {
            await addDoc(collection(db, "riwayat_psikotes"), {
                uid: auth.currentUser.uid,
                nama: auth.currentUser.displayName,
                modul: window.currentDatabaseId || "PAPI Kostick",
                status: status,
                fail_count: totalFail,
                detail_skor: detail,
                // --- TAMBAHKAN BARIS INI ---
                createdAt: new Date() 
                // ---------------------------
            });
            console.log("Data PAPI Tersimpan!");
        } catch (e) {
            console.error("Gagal simpan PAPI:", e);
        }
    };

// --- FUNGSI DUAL MODE LEADERBOARD (FIXED & FILTER PAPI) ---
    window.openLeaderboard = async (mode = 'local') => {
        // 1. Cek Database
        if (!window.db) { 
            console.error("Database belum siap!"); 
            alert("Tunggu sebentar, sedang menyambungkan ke server..."); 
            return; 
        }
        
        console.log("Membuka Leaderboard Mode:", mode); // Cek Console (F12) kalau gak muncul

        // 2. Siapkan UI Overlay
        const overlay = document.getElementById('leaderboardOverlay');
        const tbody = document.getElementById('leaderboardBody');
        const titleEl = document.getElementById('lbModulName');
        // Selector Header Tabel yang lebih aman
        const tableHeader = document.querySelector('#leaderboardOverlay .stats-table thead tr');

        if(overlay) overlay.style.display = 'flex';
        if(tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Memuat Data...</td></tr>';

        try {
            // Import fungsi yang dibutuhkan dari Firebase (biar aman kalau belum ke-load)
            const { collection, query, orderBy, limit, getDocs, where } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            // === MODE 1: GLOBAL RANKING (HANYA HUKUM & TPA) ===
            if (mode === 'global') {
                if(titleEl) titleEl.innerText = "Ranking Global (Hukum & TPA)";
                
                // Ubah Header Tabel: No | Nama | Nilai | Total Tes
                if(tableHeader) tableHeader.innerHTML = '<th style="width:10%">No</th><th>Nama</th><th style="width:20%">Nilai</th><th style="width:25%">Total Tes</th>';
                
                // Ambil 1000 data teratas
                const qLb = query(collection(window.db, "leaderboard"), orderBy("skor", "desc"), limit(1000));
                const snapLb = await getDocs(qLb);
                
                let userTotals = {}; 
                
                snapLb.forEach(doc => {
                    const d = doc.data();
                    
                    // --- üî• FILTER SAKTI: BUANG PAPI KOSTICK üî• ---
                    // Cek apakah modul mengandung kata 'papi' atau id-nya 'modul18'
                    const namaModul = d.modul ? d.modul.toString().toLowerCase() : "";
                    if (namaModul.includes('papi') || namaModul === 'modul18') {
                        return; // SKIP DATA INI (Gak dihitung)
                    }

                    const nilai = parseInt(d.skor) || 0;
                    
                    // Inisialisasi object user kalau belum ada
                    if (!userTotals[d.nama]) userTotals[d.nama] = {};
                    
                    // Logic: Hanya ambil nilai TERTINGGI di setiap modul
                    // (Supaya kalau ngerjain berkali-kali, yang dihitung cuma yang paling bagus)
                    if (!userTotals[d.nama][d.modul] || nilai > userTotals[d.nama][d.modul]) {
                        userTotals[d.nama][d.modul] = nilai;
                    }
                });

                // Hitung Total Poin
                let rankingList = [];
                for (let [nama, modules] of Object.entries(userTotals)) {
                    const totalPoints = Object.values(modules).reduce((a, b) => a + b, 0);
                    const moduleCount = Object.keys(modules).length;
                    rankingList.push({ nama: nama, total: totalPoints, count: moduleCount });
                }

                // Urutkan Peringkat (Poin Tertinggi di Atas)
                rankingList.sort((a, b) => b.total - a.total);

                // Render ke Tabel
                if(tbody) {
                    tbody.innerHTML = '';
                    if (rankingList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">Belum ada data Hukum/TPA.</td></tr>';
                    } else {
                        // Tampilkan Top 50 Aja biar gak berat
                        rankingList.slice(0, 50).forEach((val, index) => {
                            let rankDisplay = index + 1;
                            let rowStyle = '';
                            let icon = '';
                            
                            // Styling Juara
                            if (index === 0) { rowStyle = 'background:#fff9c4; font-weight:bold;'; icon = 'ü•á '; }
                            else if (index === 1) { rowStyle = 'background:#f5f5f5; font-weight:bold;'; icon = 'ü•à '; }
                            else if (index === 2) { rowStyle = 'background:#fff; border:1px solid #d7ccc8; font-weight:bold;'; icon = 'ü•â '; }

                            let tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="text-align:center; ${rowStyle}">${icon}${rankDisplay}</td>
                                <td style="${rowStyle}">${val.nama}</td>
                                <td style="text-align:center; ${rowStyle}">${val.total} Pts</td>
                                <td style="text-align:center; font-size:0.85rem; ${rowStyle}">${val.count} Modul</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }

            } 
            // === MODE 2: LOCAL RANKING (PER MODUL) ===
            else {
                const currentModul = window.currentDatabaseId || "modul1";
                if(titleEl) {
                    const elJudul = document.getElementById('modulTitle');
                    titleEl.innerText = elJudul ? elJudul.innerText : currentModul;
                }

                // Balikin Header Tabel: No | Nama | Skor | Waktu
                if(tableHeader) tableHeader.innerHTML = '<th style="width:10%">#</th><th>Nama</th><th style="width:20%">Skor</th><th style="width:25%">Waktu</th>';

                const q = query(collection(window.db, "leaderboard"), where("modul", "==", currentModul), orderBy("skor", "desc"), limit(50));
                const snapshot = await getDocs(q);
                
                const bestScores = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!bestScores[data.nama] || parseInt(data.skor) > parseInt(bestScores[data.nama].skor)) {
                        bestScores[data.nama] = data;
                    }
                });
                
                let sortedData = Object.values(bestScores).sort((a, b) => b.skor - a.skor);
                
                if(tbody) {
                    tbody.innerHTML = '';
                    if (sortedData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">Belum ada data modul ini.</td></tr>';
                    } else {
                        sortedData.forEach((val, index) => {
                            let tgl = val.tanggal && val.tanggal.seconds ? new Date(val.tanggal.seconds * 1000).toLocaleDateString('id-ID') : '-';
                            let tr = document.createElement('tr');
                            tr.innerHTML = `<td>${index + 1}</td><td>${val.nama}</td><td>${val.skor}</td><td>${tgl}</td>`;
                            tbody.appendChild(tr);
                        });
                    }
                }
            }

        } catch (error) { 
            console.error("Error Leaderboard:", error); 
            if(tbody) tbody.innerHTML = `<tr><td colspan="4" style="color:red;">Gagal memuat: ${error.message}</td></tr>`; 
        }
    };

    window.closeLeaderboard = () => { document.getElementById('leaderboardOverlay').style.display = 'none'; };

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
        
    let currentModulKey = 'modul1';
    let currentQuestions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let raguStatus = [];
    let isSubmitted = false;
    let timerInterval;
    let timeRemaining;
    let totalExamTime = 0;
    let isReviewMode = false;
    let wrongIndices = [];

    window.currentDatabaseId = 'modul1';

    // --- FIX TOGGLE SIDEBAR HP (AUTO HIDE BUTTONS) ---
    window.toggleMobileSidebar = function() {
        const sidebar = document.querySelector('.sidebar-right');
        const floatingTimer = document.getElementById('floatingTimer');
        const mobileFooter = document.getElementById('mobileFooter');

        sidebar.classList.toggle('show-mobile');

        // LOGIKA BARU: Kalau sidebar kebuka, UMPETIN tombol navigasi
        if (sidebar.classList.contains('show-mobile')) {
            if(floatingTimer) floatingTimer.style.setProperty('display', 'none', 'important');
            mobileFooter.style.display = 'none'; // FIX: Display None langsung
        } else {
            // Kalau sidebar ketutup, MUNCULIN lagi (hanya pas ujian)
            if (document.body.classList.contains('ujian-berjalan')) {
                if(floatingTimer) floatingTimer.style.display = 'block';
                mobileFooter.style.display = 'flex'; // FIX: Flex balik
            }
        }

        if (!document.getElementById('btnCloseMobile')) {
            const btnClose = document.createElement('button');
            btnClose.id = 'btnCloseMobile';
            btnClose.className = 'close-sidebar-btn';
            btnClose.innerHTML = 'Tutup Daftar Soal ‚úñÔ∏è';
            btnClose.onclick = window.toggleMobileSidebar;
            sidebar.insertBefore(btnClose, sidebar.firstChild);
        }
    }

    // --- FIX TOGGLE MODUL HP (AUTO HIDE BUTTONS) ---
    window.toggleMobileModul = function() {
        const sidebar = document.querySelector('.sidebar-left');
        const timer = document.getElementById('floatingTimer');
        const mobileFooter = document.getElementById('mobileFooter');

        if (sidebar.style.display === 'flex') {
            // TUTUP SIDEBAR
            sidebar.style.display = ''; 
            if(timer && document.body.classList.contains('ujian-berjalan')) timer.style.display = 'block';
            if(mobileFooter) mobileFooter.style.display = 'flex';
        } else {
            // BUKA SIDEBAR
            sidebar.style.display = 'flex'; 
            if(timer) timer.style.display = 'none';
            if(mobileFooter) mobileFooter.style.display = 'none';
        }
    }

    document.addEventListener('keydown', function(event) {
        if(document.getElementById('appSection').style.display === 'none') return;
        switch(event.key) {
            case "ArrowRight": changeQuestion(1); break;
            case "ArrowLeft": changeQuestion(-1); break;
            case "a": case "A": selectKey(0); break;
            case "b": case "B": selectKey(1); break;
            case "c": case "C": selectKey(2); break;
            case "d": case "D": selectKey(3); break;
            case "e": case "E":
                if(!isSubmitted) {
                    const chk = document.getElementById('checkRagu');
                    if(chk) { chk.checked = !chk.checked; toggleRagu(); }
                }
                break;
        }
    });

    function selectKey(idx) {
        if(!isSubmitted && !isReviewMode) {
            let labels = document.getElementsByClassName('option-label');
            if(labels[idx]) labels[idx].click();
        }
    }

    window.switchDatabase = async function(key) {
        if (typeof timerInterval !== 'undefined' && timerInterval) clearInterval(timerInterval);
        window.speechSynthesis.cancel();
        
        // --- UPDATE BARU: SWAP SIDEBAR KE MODE UJIAN ---
        document.getElementById('lobbySidebarContent').style.display = 'none';
        const examSide = document.getElementById('examSidebarContent');
        if(examSide) examSide.style.display = 'flex';
        currentModulKey = key;
        window.currentDatabaseId = key;
        
        const qText = document.getElementById('questionText');
        const optCont = document.getElementById('optionsContainer');
        const footer = document.querySelector('.footer-nav');
        
        if(qText) qText.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                <p style="font-weight: 600; color: #555; animation: blink 1s infinite;">Sedang menyiapkan soal...</p>
            </div>
            <style>@keyframes blink { 50% { opacity: 0.5; } }</style>
        `;
        if(optCont) optCont.innerHTML = '';
        if(footer) footer.style.visibility = 'hidden';

        try {
            const docRef = doc(db, "bank_soal", key);
            const docSnap = await getDoc(docRef);
            let judulModul = "Modul Latihan";
            if (docSnap.exists()) {
                judulModul = docSnap.data().title;
            }

            const qRef = collection(db, "bank_soal", key, "daftar_soal");
            const qSnap = await getDocs(qRef);

            if (qSnap.empty) {
                alert("‚ö†Ô∏è Soal untuk modul ini belum di-upload ke server!");
                if(qText) qText.innerText = "Belum ada soal.";
                return;
            }

            let rawQuestions = [];
            qSnap.forEach((doc) => {
                rawQuestions.push(doc.data());
            });

            shuffleArray(rawQuestions); 
            rawQuestions.forEach(q => {
                if(q.options && q.answer < q.options.length) {
                    let correctText = q.options[q.answer]; 
                    shuffleArray(q.options); 
                    q.answer = q.options.indexOf(correctText); 
                }
            });

            currentQuestions = rawQuestions;
            userAnswers = new Array(currentQuestions.length).fill(null);
            raguStatus = new Array(currentQuestions.length).fill(false);
            isSubmitted = false;
            isReviewMode = false;
            currentIdx = 0;

            document.querySelectorAll('.modul-btn').forEach(btn => btn.classList.remove('active-modul'));
            const activeBtn = document.getElementById('btn-'+key);
            if(activeBtn) activeBtn.classList.add('active-modul');

            const titleEl = document.getElementById('modulTitle');
            if(titleEl) titleEl.innerText = judulModul;
            
            const modeInd = document.getElementById('modeIndicator');
            if(modeInd) {
                modeInd.innerText = "Mode: Ujian";
                modeInd.style = "color: var(--warning); font-weight: bold; background:#fff3e0; padding:5px 15px; border-radius:20px; border:1px solid #ffe0b2; display:block;";
            }
            
            const finishCont = document.querySelector('.finish-container');
            if(finishCont) finishCont.style.display = 'block';
            
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('statsOverlay').style.display = 'none';
            document.getElementById('leaderboardOverlay').style.display = 'none';
            const btnScore = document.getElementById('btnShowScore');
            if(btnScore) btnScore.style.display = 'none';
            
            if(footer) {
                footer.style.visibility = 'visible';
                footer.style.display = 'flex';
            }
            if(qText) qText.style.display = 'block';
            
            totalExamTime = currentQuestions.length * 30; 
            timeRemaining = totalExamTime;
            
                updateTimerDisplay();
                renderSidebarGrid(); // Render grid tetap jalan untuk semua modul
            
            // --- LOGIKA KHUSUS DAYA INGAT (MODUL 19.3) ---
            if (key === 'modul19.3') {
                // Hentikan timer lama jika ada, lalu munculkan overlay hafalan
                if (typeof timerInterval !== 'undefined' && timerInterval) clearInterval(timerInterval);
                showMemorizationPhase(); 
            } else {
                // Untuk modul hukum/TPA lain, langsung jalankan timer dan tampilkan soal
                startTimer();
                loadQuestion(0);
            }
            
            if(window.innerWidth <= 768) {
                document.body.classList.add('ujian-berjalan'); 
                // FIX: Munculkan Footer HP HANYA saat ujian dimulai
                const mobileFooter = document.getElementById('mobileFooter');
                if(mobileFooter) mobileFooter.style.display = 'flex';
                
                const timer = document.getElementById('floatingTimer');
                if(timer) timer.style.display = 'block';
                const sbLeft = document.querySelector('.sidebar-left');
                if(sbLeft) sbLeft.style.display = ''; 
            }

        } catch (e) {
            console.error("Error ambil data:", e);
            alert("Gagal memuat soal: " + e.message);
        }
    };

    window.downloadSoal = async function(modulKey) {
        console.log(`Sedang mendownload soal ${modulKey}...`);
        const qRef = collection(db, "bank_soal", modulKey, "daftar_soal");
        const snapshot = await getDocs(qRef);
        let dataSoal = [];
        snapshot.forEach(doc => {
            const d = doc.data();
            dataSoal.push({
                q: d.q, options: d.options, answer: d.answer, explanation: d.explanation, cite: d.cite
            });
        });
        console.log("‚úÖ COPY TEKS DI BAWAH INI KE NOTEPAD:");
        console.log(JSON.stringify(dataSoal, null, 2)); 
        return dataSoal;
    };

    window.timpaModul = async function(modulKey, dataBaruJson) {
        if(!confirm(`‚ö†Ô∏è BAHAYA: Ini akan MENGHAPUS semua soal lama di ${modulKey} dan menggantinya dengan data baru. Yakin?`)) return;
        const qRef = collection(db, "bank_soal", modulKey, "daftar_soal");
        const snapshot = await getDocs(qRef);
        const batchDelete = writeBatch(db);
        snapshot.forEach(doc => { batchDelete.delete(doc.ref); });
        await batchDelete.commit();
        const chunks = [];
        let currentBatch = writeBatch(db);
        let count = 0;
        for (const soal of dataBaruJson) {
            const newDocRef = doc(collection(db, "bank_soal", modulKey, "daftar_soal"));
            currentBatch.set(newDocRef, soal);
            count++;
            if (count >= 490) {
                chunks.push(currentBatch);
                currentBatch = writeBatch(db);
                count = 0;
            }
        }
        if (count > 0) chunks.push(currentBatch);
        for (let batch of chunks) await batch.commit();
        alert("‚úÖ SUKSES! Modul berhasil direvisi total.");
        location.reload(); 
    };
    
    function startTimer() {
        timerInterval = setInterval(() => {
            if(timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); }
            else { clearInterval(timerInterval); finishTime(); }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        const textWaktu = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        const t1 = document.getElementById('timerDisplay');
        const t2 = document.getElementById('floatingTimer');
        if(t1) t1.innerText = textWaktu;
        if(t2) t2.innerText = textWaktu;
        let persentase = (timeRemaining / totalExamTime) * 100;
        let colorClass = 'timer-green';
        if (persentase <= 10) colorClass = 'timer-panic';
        else if (persentase <= 30) colorClass = 'timer-yellow';
        if(t1) t1.className = 'timer-container ' + colorClass;
        if(t2) t2.className = colorClass;
    }

    function finishTime() { alert("Waktu Habis!"); submitQuiz(); }

    function renderSidebarGrid() {
        const grid = document.getElementById('navGrid');
        grid.innerHTML = '';
        currentQuestions.forEach((_, idx) => {
            const btn = document.createElement('div');
            btn.className = 'nav-btn';
            btn.id = `nav-${idx}`;
            btn.innerText = idx + 1;
            btn.onclick = () => {
                loadQuestion(idx);
                if (window.innerWidth <= 768) {
                      const sb = document.querySelector('.sidebar-right');
                      if (sb && sb.classList.contains('show-mobile')) {
                          window.toggleMobileSidebar(); 
                      }
                }
            };
            grid.appendChild(btn);
        });
        updateSidebarStatus();
    }

    function updateSidebarStatus() {
        currentQuestions.forEach((q, idx) => {
            const btn = document.getElementById(`nav-${idx}`);
            if(!btn) return;
            btn.classList.remove('active', 'filled', 'correct', 'wrong', 'ragu');
            if (idx === currentIdx) btn.classList.add('active');
            if (isSubmitted) {
                if (userAnswers[idx] === q.answer) btn.classList.add('correct');
                else btn.classList.add('wrong');
            } else {
                if (raguStatus[idx]) btn.classList.add('ragu');
                else if (userAnswers[idx] !== null) btn.classList.add('filled');
            }
        });
    }

    function loadQuestion(idx) {
        // Matikan audio saat ganti soal
        window.speechSynthesis.cancel();
        const btnSpeakIcon = document.querySelector('#btnSpeak i');
        if(btnSpeakIcon) btnSpeakIcon.className = 'fas fa-volume-up';

        document.querySelector('.question-header').style.visibility = 'visible';
        document.querySelector('.footer-nav').style.visibility = 'visible';
        currentIdx = idx;
        const q = currentQuestions[idx];
        if (!q) return;

        // FIX: Auto scroll ke atas saat ganti soal
        const mainContent = document.querySelector('.main-content');
        if(mainContent) mainContent.scrollTop = 0;

        document.getElementById('qNum').innerText = idx + 1;
        document.getElementById('questionText').innerText = q.q;
        
        updateSidebarStatus();
        updateProgress();
        
        document.getElementById('prevBtn').disabled = (isReviewMode ? false : idx === 0);
        
        const btnNext = document.getElementById('nextBtn');
        btnNext.style.display = 'block'; 

        if (!isReviewMode && idx === currentQuestions.length - 1) {
            if (window.innerWidth > 768) {
                btnNext.style.display = 'none';
            } else {
                btnNext.innerHTML = "Selesai";
                btnNext.className = "btn btn-finish"; 
                btnNext.onclick = confirmFinish; 
            }
        } else {
            btnNext.innerHTML = "Selanjutnya ‚ùØ";
            btnNext.className = "btn btn-next"; 
            btnNext.onclick = () => changeQuestion(1);
        }
        
        if (isReviewMode) {
             btnNext.style.display = 'block';
             btnNext.innerHTML = "Lanjut (Salah) ‚ùØ";
             btnNext.className = "btn btn-next";
             btnNext.onclick = () => changeQuestion(1);
        }

        const fb = document.getElementById('feedbackBox');
        if (isSubmitted) {
            fb.style.display = 'block';
            fb.classList.add('show');
            const teksPembahasan = q.explanation || "";
            const jawabanBenar = q.options[q.answer]; 
            
            // --- LOGIKA HIGHLIGHT JAWABAN (KEY ANSWER BRIDGE) ---
            const highlightTeks = (teks, keyword) => {
                if (!keyword) return teks;
                const regex = new RegExp(`(${keyword})`, 'gi');
                return teks.replace(regex, `<span style="background-color: #fff9c4; color: #004d00; font-weight: bold; padding: 0 2px; border-bottom: 2px solid #d4af37;">$1</span>`);
            };

            document.getElementById('feedbackText').innerHTML = highlightTeks(teksPembahasan, jawabanBenar);
            document.getElementById('feedbackCite').innerText = "Sumber: " + q.cite;
        } else { 
            fb.style.display = 'none';
            fb.classList.remove('show'); 
        }

        const cont = document.getElementById('optionsContainer');
        cont.innerHTML = '';
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option-label';
            if(isSubmitted) {
                div.style.cursor = 'default';
                if(userAnswers[idx] === i) {
                    div.innerHTML = i === q.answer ? opt + ' ‚úÖ' : opt + ' ‚ùå';
                    div.classList.add(i === q.answer ? 'review-correct' : 'review-wrong');
                }
                else if(i === q.answer) {
                    div.innerHTML = opt + ' ‚¨ÖÔ∏è (Jawaban Benar)';
                    div.classList.add('review-correct');
                } else {
                    div.innerHTML = opt;
                }
            } else {
                div.innerHTML = opt;
                div.onclick = () => { 
                    if(!isSubmitted) { 
                        userAnswers[idx] = i; 
                        raguStatus[idx] = false; 
                        loadQuestion(idx); 
                    } 
                };
                if(userAnswers[idx] === i) div.classList.add('selected');
            }
            cont.appendChild(div);
        });

        const chk = document.getElementById('checkRagu');
        if(chk) {
            chk.checked = raguStatus[idx] || false;
            chk.disabled = isSubmitted;
        }
    }

// ==========================================
    // FUNGSI SUBMIT V4.0 (DATABASE TERPISAH)
    // ==========================================
    window.submitQuiz = function() {
        if(typeof timerInterval !== 'undefined' && timerInterval) clearInterval(timerInterval);
        window.speechSynthesis.cancel();
        
        const currentDB = window.currentDatabaseId || "";
        console.log("DEBUG: ID Modul ->", currentDB);

        // ==========================================
        // CABANG 1: MODE PSIKOLOG (MODUL 18 / PAPI) - FINAL PDF VERSION
        // ==========================================
        if (currentDB === 'modul18' || currentDB.includes('papi') || currentDB === 'modul_papi') {
            
            const floatTimer = document.getElementById('floatingTimer');
            if(floatTimer) floatTimer.style.display = 'none';
            document.body.classList.remove('mode-focus');
            isSubmitted = true;

            let papiScores = {}; 
            // Inisialisasi 20 Aspek PAPI Standard (Wadah Hitung)
            const traits = ['G','L','I','T','V','S','R','D','C','E','N','A','P','X','B','O','Z','K','F','W'];
            traits.forEach(t => papiScores[t] = 0);

            // 1. HITUNG SKOR MURNI DARI JAWABAN
            userAnswers.forEach((choiceIndex, qIndex) => {
                if (choiceIndex !== null && currentQuestions[qIndex]) {
                    const qData = currentQuestions[qIndex];
                    if (qData.papi_keys && qData.papi_keys.length === 2) {
                        const aspect = qData.papi_keys[choiceIndex];
                        if(papiScores[aspect] !== undefined) papiScores[aspect]++; 
                    }
                }
            });

            // 2. KONFIGURASI TARGET SESUAI PDF "FORMAT PENILAIAN HAKIM KHUSUS"
            // Mapping: Key PDF -> Key PAPI Standard (Supaya sinkron dengan database)
            // M -> F (Disiplin/Authority), D -> I (Decision Making), A -> D (Detail)
            
            const pdfTargets = [
                // === KELOMPOK WAJIB TINGGI ===
                { id: 'R', mapTo: 'R', min: 6, max: 9, label: "Role Consistency (Rasional)", cat: "WAJIB" },
                { id: 'D', mapTo: 'I', min: 5, max: 7, label: "Decision Making (Tegas & Hati-hati)", cat: "WAJIB" }, // PDF 'D' = PAPI 'I'
                { id: 'E', mapTo: 'E', min: 6, max: 9, label: "Emotional Restraint (Tenang)", cat: "WAJIB" },
                { id: 'M', mapTo: 'F', min: 6, max: 9, label: "Discipline / Order (Patuh Hukum Acara)", cat: "WAJIB" }, // PDF 'M' = PAPI 'F'
                { id: 'B', mapTo: 'B', min: 6, max: 9, label: "Perseverance (Ketekunan)", cat: "WAJIB" },
                { id: 'N', mapTo: 'N', min: 6, max: 9, label: "Need to Finish (Tuntas)", cat: "WAJIB" },
                { id: 'C', mapTo: 'C', min: 6, max: 9, label: "Conformity (Rapi & Tertib)", cat: "WAJIB" },
                { id: 'A', mapTo: 'D', min: 6, max: 9, label: "Attention to Detail (Teliti)", cat: "WAJIB" }, // PDF 'A' = PAPI 'D'
                { id: 'Z', mapTo: 'Z', min: 5, max: 7, label: "Self Control (Adaptif)", cat: "WAJIB" },
                { id: 'W', mapTo: 'W', min: 7, max: 9, label: "Need for Rules (Patuh Etik/SOP)", cat: "WAJIB" },

                // === KELOMPOK MENENGAH ===
                { id: 'L', mapTo: 'L', min: 4, max: 6, label: "Leadership (Wibawa)", cat: "NORMAL" },
                { id: 'T', mapTo: 'T', min: 4, max: 6, label: "Work Tempo (Kecepatan)", cat: "NORMAL" },
                { id: 'V', mapTo: 'V', min: 4, max: 6, label: "Vigor (Stamina Fisik)", cat: "NORMAL" },
                { id: 'P', mapTo: 'P', min: 5, max: 7, label: "Independence (Mandiri)", cat: "NORMAL" },

                // === KELOMPOK RISK (HINDARI) ===
                { id: 'X', mapTo: 'X', min: 0, max: 4, label: "Need to be Noticed (Ingin Tampil)", cat: "RISK" },
                { id: 'S', mapTo: 'S', min: 0, max: 4, label: "Social Extension (Mudah Dipengaruhi)", cat: "RISK" },
                { id: 'G', mapTo: 'G', min: 0, max: 4, label: "Influence / Dominance", cat: "RISK" },
                { id: 'K', mapTo: 'K', min: 0, max: 3, label: "Aggression (Emosional)", cat: "RISK" },
                { id: 'O', mapTo: 'O', min: 0, max: 3, label: "Need for Closeness (Ketergantungan)", cat: "RISK" }
            ];

            // 3. PROSES ANALISIS & GENERATE REPORT
            let analysisTableRows = "";
            let riskCount = 0;
            let wajibFailCount = 0;
            let detailNotes = [];

            pdfTargets.forEach(t => {
                // Ambil skor menggunakan key mapping (Standar PAPI)
                // Jika mapping tidak ditemukan, pakai skor 0 sebagai fallback
                const score = papiScores[t.mapTo] !== undefined ? papiScores[t.mapTo] : 0;
                
                let status = "‚úÖ OK";
                let color = "green";
                let rowBg = "";

                // Logika Evaluasi
                if (score < t.min || score > t.max) {
                    if (t.cat === "RISK" && score > t.max) {
                        status = "‚õî BAHAYA";
                        color = "red";
                        rowBg = "#ffebee";
                        riskCount++;
                        detailNotes.push(`‚ö†Ô∏è <b>${t.label}</b> Tinggi (${score}). Risiko pelanggaran etik/independensi.`);
                    } 
                    else if (t.cat === "WAJIB") {
                        status = score < t.min ? "KURANG" : "BERLEBIH";
                        color = "#d35400"; // Orange Tua
                        rowBg = "#fff3e0";
                        wajibFailCount++;
                        if (score < t.min) detailNotes.push(`üî∏ <b>${t.label}</b> Rendah (${score}). Perlu ditingkatkan.`);
                    } 
                    else {
                        status = "‚ö†Ô∏è Cek";
                        color = "#f39c12"; // Kuning
                    }
                }

                analysisTableRows += `
                <tr style="border-bottom:1px solid #eee; background-color:${rowBg};">
                    <td style="padding:6px;"><b>${t.id}</b> - ${t.label}</td>
                    <td style="padding:6px; text-align:center;">${t.min}-${t.max}</td>
                    <td style="padding:6px; text-align:center; font-weight:bold; font-size:1.1rem;">${score}</td>
                    <td style="padding:6px; font-weight:bold; color:${color}; text-align:right;">${status}</td>
                </tr>`;
            });

            const analysisTable = `
                <table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;">
                    <tr style="background:#f5f5f5; text-align:left; border-bottom:2px solid #ddd;">
                        <th style="padding:8px;">Aspek (PDF)</th>
                        <th style="padding:8px; text-align:center;">Target</th>
                        <th style="padding:8px; text-align:center;">Skor</th>
                        <th style="padding:8px; text-align:right;">Status</th>
                    </tr>
                    ${analysisTableRows}
                </table>
            `;

            // 4. KESIMPULAN AKHIR
            let statusAkhir = "DISARANKAN";
            let statusColor = "#2ecc71";
            let icon = "‚öñÔ∏è";
            let headerMsg = "Profil Sesuai Standar Kompetensi Hakim.";

            if (riskCount > 0) {
                statusAkhir = "PERLU PERBAIKAN";
                statusColor = "#c0392b"; // Merah
                icon = "‚õî";
                headerMsg = `Ditemukan ${riskCount} Indikator Risiko Tinggi!`;
            } else if (wajibFailCount > 2) { // Toleransi gagal wajib max 2
                statusAkhir = "PERLU PERBAIKAN";
                statusColor = "#e67e22"; // Orange
                icon = "‚ö†Ô∏è";
                headerMsg = `Profil belum konsisten (Gagal di ${wajibFailCount} aspek inti).`;
            }

            // Update UI
            const scoreCircle = document.getElementById('finalScore');
            const passStatus = document.getElementById('passStatus');
            const msg = document.getElementById('resultMsg');
            const btnReview = document.getElementById('btnReviewWrong');
            
            scoreCircle.innerText = icon;
            scoreCircle.style.background = statusColor;
            passStatus.innerText = statusAkhir;
            passStatus.style.color = statusColor;
            
            msg.innerHTML = `<div style="text-align:left; margin-bottom:10px; font-weight:bold; color:${statusColor}">${headerMsg}</div>`;
            
            if (detailNotes.length > 0) {
                msg.innerHTML += `<div style="text-align:left; font-size:0.85rem; background:#fff8e1; padding:10px; border-radius:6px; border:1px solid #ffe0b2; margin-bottom:15px;">
                    <strong>Catatan Penting:</strong>
                    <ul style="margin:5px 0 0 0; padding-left:20px; color:#5d4037;">
                        ${detailNotes.map(n => `<li>${n}</li>`).join('')}
                    </ul>
                </div>`;
            }

            msg.innerHTML += `<div style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:6px;">${analysisTable}</div>`;

            if(btnReview) btnReview.style.display = 'none';
            document.getElementById('modeIndicator').innerText = "PSIKOGRAM";
            document.getElementById('resultOverlay').style.display = 'flex';

            const btnShowScore = document.getElementById('btnShowScore');
            if(btnShowScore) {
                btnShowScore.style.display = 'flex'; // Paksa tombol muncul
                btnShowScore.innerHTML = "üìù Nilai"; 
                // Set onclick supaya ngebuka pop-up lagi
                btnShowScore.onclick = function() {
                    document.getElementById('resultOverlay').style.display = 'flex';
                };
            }
            
      // üî• 1. CATAT MAPPING NOMOR SOAL KE ELEMEN üî•
            let elementMapping = {};
            userAnswers.forEach((choiceIndex, qIndex) => {
                if (choiceIndex !== null && currentQuestions[qIndex]) {
                    const qData = currentQuestions[qIndex];
                    if (qData.papi_keys) {
                        const aspect = qData.papi_keys[choiceIndex];
                        if (!elementMapping[aspect]) elementMapping[aspect] = [];
                        elementMapping[aspect].push(qIndex + 1); // Simpan nomor soal (1, 2, 3...)
                    }
                }
            });
    
            // üî• 2. SIMPAN KE DATABASE (LENGKAP DENGAN MAPPING) üî•
            if (typeof window.savePapiToCloud === 'function') {
                const totalFail = riskCount + wajibFailCount;
                // Kita bungkus skor dan mapping soal dalam satu objek
                window.savePapiToCloud(statusAkhir, totalFail, JSON.stringify({
                    scores: papiScores,
                    mapping: elementMapping
                }));
            }
            return;
        }
        
        // ==========================================
        // CABANG 2: MODE NORMAL (HUKUM)
        // ==========================================
        isSubmitted = true;
        document.getElementById('floatingTimer').style.display = 'none';
        document.body.classList.remove('mode-focus');

        let score = 0;
        let correctCount = 0;
        let wrongCount = 0;
        wrongIndices = []; 

        userAnswers.forEach((a, i) => {
            if (currentQuestions[i]) {
                if(a === currentQuestions[i].answer) {
                    score++; correctCount++;
                } else {
                    wrongCount++;
                    wrongIndices.push(i);
                }
            }
        });
        
        const final = Math.round((score/currentQuestions.length)*100);
        
        document.getElementById('resultOverlay').style.display = 'flex';
        const scoreCircle = document.getElementById('finalScore');
        const passStatus = document.getElementById('passStatus');
        const msg = document.getElementById('resultMsg');
        
        scoreCircle.innerText = final;
        scoreCircle.style.background = final >= 70 ? "var(--pass)" : "var(--fail)";
        passStatus.innerText = final >= 70 ? "LULUS" : "TIDAK LULUS";
        passStatus.style.color = final >= 70 ? "var(--pass)" : "var(--fail)";
        msg.innerText = final >= 70 ? "Selamat! Memenuhi Standar." : "Belajar lagi ya.";

        const btnReview = document.getElementById('btnReviewWrong');
        if (wrongCount > 0) {
            btnReview.style.display = 'block';
            btnReview.innerText = `üîç Review ${wrongCount} Jawaban Salah`;
        } else {
            btnReview.style.display = 'none';
        }
        
        const btnShowScore = document.getElementById('btnShowScore');
        if(btnShowScore) {
            btnShowScore.style.display = 'flex';
            btnShowScore.innerHTML = "üìù Nilai"; 
        }

        document.getElementById('modeIndicator').innerText = "PEMBAHASAN";
        document.getElementById('modeIndicator').style.color = "var(--success)";
        document.querySelector('.finish-container').style.display = 'none';

        // SIMPAN KE DATABASE NORMAL (GRAFIK)
        if (typeof window.saveScoreToCloud === 'function') window.saveScoreToCloud(currentDB, final);
        if (typeof window.saveAndShowChart === 'function') window.saveAndShowChart(final, correctCount, wrongCount);
        
        loadQuestion(currentIdx);
    };
    
    window.confirmFinish = function() {
        const emptyCount = userAnswers.filter(a => a === null).length;
        const raguCount = raguStatus.filter(r => r === true).length;
        let msg = "Yakin mau menyelesaikan ujian?";
        if(emptyCount > 0 || raguCount > 0) {
            msg = `‚ö†Ô∏è PERHATIAN!\n\n`;
            if (raguCount > 0) msg += `- Ada ${raguCount} soal RAGU-RAGU\n`;
            if (emptyCount > 0) msg += `- Ada ${emptyCount} soal BELUM DIJAWAB\n`;
            msg += `\nYakin mau dikumpulkan sekarang?`;
        }
        if(confirm(msg)) submitQuiz();
    }

    window.closeResult = function() {
        if (window.innerWidth <= 768) {
            const sb = document.querySelector('.sidebar-right');
            if (sb && sb.classList.contains('show-mobile')) {
                window.toggleMobileSidebar();
            }
        }
        document.getElementById('resultOverlay').style.display = 'none';
        isReviewMode = false; 
        const ind = document.getElementById('modeIndicator');
        if (ind) {
            ind.innerText = "PEMBAHASAN";
            ind.style.background = "#e8f5e9";
            ind.style.color = "#2e7d32";
            ind.style.border = "1px solid #c8e6c9";
        }
        document.getElementById('prevBtn').disabled = false;
        document.getElementById('nextBtn').style.display = 'block';
        const mainContent = document.querySelector('.main-content');
        if(mainContent) mainContent.scrollTop = 0;
        loadQuestion(currentIdx);
    };

    window.startReviewWrong = function() {
        if (!wrongIndices || wrongIndices.length === 0) {
            alert("Tidak ada jawaban salah untuk direview.");
            return;
        }
        if (window.innerWidth <= 768) {
            const sb = document.querySelector('.sidebar-right');
            if (sb && sb.classList.contains('show-mobile')) {
                window.toggleMobileSidebar();
            }
        }
        
        isReviewMode = true;
        const overlay = document.getElementById('resultOverlay');
        if(overlay) overlay.style.setProperty('display', 'none', 'important');
        
        const ind = document.getElementById('modeIndicator');
        ind.innerText = "MODE: REVIEW SALAH";
        ind.style.background = "#ffebee";
        ind.style.color = "#c62828";
        ind.style.border = "1px solid #ffcdd2";
        
        loadQuestion(wrongIndices[0]);
    };

    window.changeQuestion = function(step) {
        if (isReviewMode) {
            let currentWrongPos = wrongIndices.indexOf(currentIdx);
            if (currentWrongPos !== -1) {
                let nextWrongPos = currentWrongPos + step;
                if (nextWrongPos >= wrongIndices.length) nextWrongPos = 0;
                if (nextWrongPos < 0) nextWrongPos = wrongIndices.length - 1;
                loadQuestion(wrongIndices[nextWrongPos]);
            } else {
                if (step > 0) {
                    let nextVal = wrongIndices.find(idx => idx > currentIdx);
                    loadQuestion(nextVal !== undefined ? nextVal : wrongIndices[0]);
                } else {
                    let prevVal = [...wrongIndices].reverse().find(idx => idx < currentIdx);
                    loadQuestion(prevVal !== undefined ? prevVal : wrongIndices[wrongIndices.length - 1]);
                }
            }
        } else {
            const next = currentIdx + step;
            if (next >= 0 && next < currentQuestions.length) loadQuestion(next);
        }
    };

   window.backToMenu = function() {
        if(confirm("Yakin mau kembali ke menu utama? Progres saat ini akan di-reset.")) {
            if(window.timerInterval) clearInterval(window.timerInterval);
            // Matikan audio
            window.speechSynthesis.cancel();
            
            // FIX 2: Pastikan Mode Fokus Hilang
            document.body.classList.remove('mode-focus');

            const btnMobile = document.getElementById('btnMobileNav');
            const btnModul = document.getElementById('btnMobileModul');
            if(btnMobile) btnMobile.style.display = 'none';
            if(btnModul) btnModul.style.display = 'none'; 
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('statsOverlay').style.display = 'none';
            document.getElementById('leaderboardOverlay').style.display = 'none';
            const sbLeft = document.querySelector('.sidebar-left');
            if(sbLeft) sbLeft.style.display = ''; 
            const sbRight = document.querySelector('.sidebar-right');
            if(sbRight) {
                sbRight.classList.remove('show-mobile'); 
                sbRight.style.display = ''; 
            }
            document.body.classList.remove('ujian-berjalan');
            const timer = document.getElementById('floatingTimer');
            if(timer) timer.style.display = 'none';
            const modulTitle = document.getElementById('modulTitle');
            if(modulTitle) modulTitle.innerText = "Menu Utama";
            document.getElementById('qNum').innerText = "-";
            tampilkanLobby();

            // Sembunyikan Footer Mobile
            if (window.innerWidth <= 768) {
                document.getElementById('mobileFooter').style.display = 'none';
            }
        }
    };
    
    window.showResult = function() {
        if(isSubmitted) {
            document.getElementById('resultOverlay').style.display = 'flex';
        } else {
            alert("Belum ada nilai! Silahkan kerjakan dulu soalnya");
        }
    };

    window.toggleRagu = function() {
        if(isSubmitted) return;
        const chk = document.getElementById('checkRagu');
        raguStatus[currentIdx] = chk.checked;
        if (chk.checked) userAnswers[currentIdx] = null;
        updateSidebarStatus();
        loadQuestion(currentIdx);
    };

    window.toggleFocusMode = function() { document.body.classList.toggle('mode-focus'); };

    // --- LOGIKA FLASHCARD MODE (ACTIVE RECALL) ---
    window.toggleHafalan = function() {
        const tempatOpsi = document.getElementById('optionsContainer');
        tempatOpsi.classList.toggle('mode-hafalan');
        
        // Logika Ganti Ikon & Warna (Brain Icon)
        const btnFlash = document.getElementById('btnFlashHafalan');
        if (tempatOpsi.classList.contains('mode-hafalan')) {
            btnFlash.style.color = 'var(--gold)'; // Aktif (Warna Emas)
        } else {
            btnFlash.style.color = 'var(--secondary)'; // Mati (Warna Hitam)
        }
    };

    // --- FITUR AUDIO PEMBAHASAN (TEXT TO SPEECH) ---
    let utterance = null;
    window.toggleSpeech = function() {
        const synth = window.speechSynthesis;
        const text = document.getElementById('feedbackText').innerText;
        const btnIcon = document.querySelector('#btnSpeak i');

        // Jika sedang bersuara, klik akan mematikan (Stop)
        if (synth.speaking) {
            synth.cancel();
            btnIcon.className = 'fas fa-volume-up';
            return;
        }

        if (text !== "") {
            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID'; // Set Bahasa Indonesia
            utterance.rate = 1.0; 

            utterance.onend = () => { 
                btnIcon.className = 'fas fa-volume-up'; 
            };
            
            btnIcon.className = 'fas fa-stop-circle'; // Ganti ikon jadi STOP saat bersuara
            synth.speak(utterance);
        }
    };

    function updateProgress() {
        let answered = userAnswers.filter(a => a !== null).length;
        let total = currentQuestions.length;
        let txt = document.getElementById('progressText');
        if(txt) txt.innerText = `Menjawab: ${answered} / ${total}`;
    }

    window.saveAndShowChart = async function(finalScore, correct, wrong) {
        const usedSeconds = totalExamTime - timeRemaining; 
        const resultData = {
            uid: currentUser.uid, nama: currentUser.displayName, modul: currentModulKey,            
            score: finalScore, correct: correct, wrong: wrong, date: new Date().toLocaleString('id-ID'), 
            timestamp: new Date(), duration: usedSeconds
        };
        try { await addDoc(collection(db, "riwayat_belajar"), resultData); } 
        catch (e) { console.error("Gagal simpan history:", e); }
    };

    window.resetStats = async function() {
        if(!confirm("‚ö†Ô∏è Yakin mau menghapus SEMUA riwayat nilai untuk modul ini? Data di Cloud akan hilang permanen.")) return;
        try {
            const q = query(collection(db, "riwayat_belajar"), where("uid", "==", currentUser.uid), where("modul", "==", window.currentDatabaseId));
            const querySnapshot = await getDocs(q);
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => { batch.delete(doc.ref); });
            await batch.commit();
            alert("Data berhasil direset!");
            window.openStats(); // <--- GUE GANTI JADI openStats() BIAR REFRESH
        } catch (e) { console.error("Gagal reset:", e); alert("Gagal menghapus data."); }
    };

 // ==========================================
// FUNGSI STATISTIK V10 (MASTER BASE + 4 HEADER FIX)
// ==========================================
window.openStats = async function(mode = 'hukum') {
    // 1. CEK LOGIN (AMAN)
    if(!currentUser) { alert("Login dulu bro!"); return; }
    
    // 2. SETUP UI
    document.getElementById('statsOverlay').style.display = 'flex';
    const wm = document.getElementById('watermark');
    if(wm) wm.style.display = 'none';
    
    const tableBody = document.getElementById('statsTableBody');
    const statsTitle = document.getElementById('statsTitle');
    
    // üî• FIX PENTING: Target Header Tabel yang Spesifik üî•
    const thead = document.querySelector('#statsOverlay .stats-table thead tr');

    const chartCanvas = document.getElementById('statsChart');
    const chartContainer = chartCanvas.parentElement; 
    
    const chartCanvas2 = document.getElementById('allModulesChart');
    let chartContainer2 = null;
    if(chartCanvas2) chartContainer2 = chartCanvas2.parentElement;

    // 3. DETEKSI POSISI (LOBBY / UJIAN)
    const lobbySidebar = document.getElementById('lobbySidebarContent');
    const isLobbyMode = (lobbySidebar && getComputedStyle(lobbySidebar).display !== 'none');

    // Reset Tabel
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Sedang mengambil data...</td></tr>';

    // 4. BUAT TOMBOL SWITCH (FITUR LAMA TETAP ADA)
    let switchContainer = document.getElementById('switchContainer');
    if (!switchContainer) {
        switchContainer = document.createElement('div');
        switchContainer.id = 'switchContainer';
        switchContainer.style = "margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;";
        switchContainer.innerHTML = `
            <button id="btnModeHukum" onclick="openStats('hukum')" style="padding: 8px 15px; border:none; border-radius:20px; cursor:pointer; font-weight:bold;">üìä Skor Akademik</button>
            <button id="btnModePsikotes" onclick="openStats('psikotes')" style="padding: 8px 15px; border:none; border-radius:20px; cursor:pointer; font-weight:bold;">üß† Kepribadian</button>
        `;
        const headerDiv = document.querySelector('#statsOverlay .result-box > div:first-child');
        if(headerDiv) headerDiv.parentNode.insertBefore(switchContainer, headerDiv.nextSibling);
    }

    // Update Warna Tombol
    const btnHukum = document.getElementById('btnModeHukum');
    const btnPsi = document.getElementById('btnModePsikotes');
    if(btnHukum) {
        btnHukum.style.background = mode === 'hukum' ? 'var(--primary)' : '#ddd';
        btnHukum.style.color = mode === 'hukum' ? 'white' : '#333';
    }
    if(btnPsi) {
        btnPsi.style.background = mode === 'psikotes' ? '#8e44ad' : '#ddd';
        btnPsi.style.color = mode === 'psikotes' ? 'white' : '#333';
    }

    // ============================================================
    // LOGIKA UTAMA (MASTER CODE + HEADER FIX)
    // ============================================================

    // ------------------------------------------------------------
    // MODE PSIKOTES (Kiri)
    // ------------------------------------------------------------
    if (mode === 'psikotes') {
        // Hide Grafik (Sesuai Master)
        if(chartContainer) chartContainer.style.display = 'none'; 
        if(chartContainer2) chartContainer2.style.display = 'none';
        const title2 = document.querySelectorAll('.stats-section-title')[1];
        if(title2) title2.style.display = 'none';

        // --- CABANG 1: LOBBY + PSIKOTES (Ranking Global) ---
        if (isLobbyMode) {
            if(statsTitle) statsTitle.innerText = "Ranking Profil Kepribadian (Global)";
            
            // üî• GANTI HEADER: No, Nama, Nilai, Indikator üî•
            if(thead) thead.innerHTML = '<th style="width:5%">No</th><th style="width:40%">Nama Peserta</th><th style="width:25%">Nilai</th><th style="width:30%">Indikator</th>';

            try {
                const q = query(collection(db, "riwayat_psikotes"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                tableBody.innerHTML = '';
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4">Belum ada data psikotes masuk.</td></tr>';
                } else {
                    let userBestMap = {};
                    querySnapshot.forEach(doc => {
                        let d = doc.data();
                        if (!d.createdAt || !d.nama) return;
                        let skorPrioritas = (d.status.includes('DISARANKAN') ? 1000 : 500) - (d.fail_count || 0);
                        d.sortingScore = skorPrioritas;
                        if (!userBestMap[d.uid] || d.sortingScore > userBestMap[d.uid].sortingScore) {
                            userBestMap[d.uid] = d;
                        }
                    });

                    let finalRanking = Object.values(userBestMap).sort((a, b) => b.sortingScore - a.sortingScore);
                    
                    finalRanking.forEach((d, idx) => {
                        const statusTeks = d.status || "Selesai";
                        const redFlagCount = d.fail_count !== undefined ? d.fail_count : 0;
                        let colorStatus = statusTeks.includes('PERLU') ? '#c0392b' : 'green';
                        let bgRow = (currentUser && d.uid === currentUser.uid) ? '#e3f2fd' : 'white';
                        let nameDisplay = (currentUser && d.uid === currentUser.uid) ? `<b>${d.nama} (Anda)</b>` : d.nama;

                        const tr = document.createElement('tr');
                        tr.style.borderBottom = "1px solid #eee";
                        tr.style.backgroundColor = bgRow;
                        
                        tr.innerHTML = `
                            <td style="padding:10px; text-align:center;">${idx + 1}</td>
                            <td style="padding:10px; text-align:left;">${nameDisplay}</td>
                            <td style="padding:10px; font-weight:bold; color:${colorStatus}; text-align:center;">${statusTeks}</td>
                            <td style="padding:10px; text-align:center;">${redFlagCount} Red Flags</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }
            } catch (e) { console.error("ERROR LOAD PSIKOTES GLOBAL:", e); }

        } 
        // --- CABANG 2: UJIAN + PSIKOTES (Riwayat Personal) ---
        else {
            if(statsTitle) statsTitle.innerText = "Riwayat Tes Kepribadian Anda";
            
            // üî• GANTI HEADER: No, Tanggal, Nilai, Indikator, Ket üî•
            if(thead) thead.innerHTML = '<th>No</th><th>Tanggal</th><th>Nilai</th><th>Indikator</th><th>Ket</th>';

            try {
                const q = query(collection(db, "riwayat_psikotes"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                tableBody.innerHTML = '';
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5">Belum ada riwayat tes PAPI.</td></tr>';
                } else {
                    querySnapshot.forEach((doc, idx) => {
                        let d = doc.data();
                        d.id = doc.id; 
                        let dDate = "-";
                        if (d.createdAt) {
                            dDate = d.createdAt.toDate().toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        }
                        
                        let statusTeks = d.status || "Selesai";
                        let redFlagCount = d.fail_count !== undefined ? d.fail_count : 0;
                        let redFlagInfo = `${redFlagCount} Flags`;
                        let colorStatus = statusTeks.includes('PERLU') ? '#c0392b' : 'green';

                        // Tombol Cek
                        let btnCek = `
                            <button class="btn-cek" onclick="bukaDetailPapi('${d.id}')" 
                                style="font-size:0.7rem; cursor:pointer; background:#3498db; color:white; border:none; padding:3px 8px; border-radius:4px;">
                                Cek
                            </button>
                        `;
                        
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = "1px solid #eee";
                        tr.innerHTML = `
                            <td style="padding:8px; text-align:center;">${idx + 1}</td>
                            <td style="padding:8px; font-size:0.75rem;">${dDate}</td>
                            <td style="padding:8px; font-weight:bold; color:${colorStatus}">${statusTeks}</td>
                            <td style="padding:8px; text-align:center;">${redFlagInfo}</td>
                            <td style="padding:8px; text-align:center;">${btnCek}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }
            } catch (e) { console.error("ERROR LOAD PSIKOTES PERSONAL:", e); }
        }

    }
    
    else {
        // Show Grafik
        if(chartContainer) chartContainer.style.display = 'block'; 
        if(chartContainer2) chartContainer2.style.display = 'block';
        const title2 = document.querySelectorAll('.stats-section-title')[1];
        if(title2) title2.style.display = 'block';

        try {
            // AMBIL DATA SEKALI AJA
            const q = query(collection(db, "riwayat_belajar"), where("uid", "==", currentUser.uid), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            let allHistory = [];
            querySnapshot.forEach((doc) => { allHistory.push(doc.data()); });

            // --- CABANG 3: LOBBY + HUKUM ---
            if (isLobbyMode) {
                if(statsTitle) statsTitle.innerText = "Rata-Rata Statistik Akademik";
                thead.innerHTML = '<th>No</th><th>Modul</th><th>Nilai</th><th>Percobaan</th><th>Ket</th>';

                let summaryStats = {};
                allHistory.forEach(h => {
                    if(!summaryStats[h.modul]) summaryStats[h.modul] = { total: 0, count: 0 };
                    summaryStats[h.modul].total += parseInt(h.score);
                    summaryStats[h.modul].count++;
                });

                tableBody.innerHTML = '';
                const sortedKeys = Object.keys(summaryStats).sort();
                
                if (sortedKeys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">Belum ada data latihan.</td></tr>';
                } else {
                    sortedKeys.forEach((key, idx) => {
                        const data = summaryStats[key];
                        const avg = Math.round(data.total / data.count);
                        const modulName = key.replace('modul', 'MODUL ').toUpperCase();
                        
                        tableBody.innerHTML += `
                            <tr>
                                <td>${idx+1}</td>
                                <td style="text-align:left;">${modulName}</td>
                                <td style="font-weight:bold; color:${avg>=70?'green':'#d35400'}">${avg}</td>
                                <td>${data.count}x</td>
                                <td>${avg>=70 ? '‚úÖ Aman' : '‚ö†Ô∏è Tingkatkan'}</td>
                            </tr>`;
                    });
                }

                // Grafik Garis Lobby
                setTimeout(() => {
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    if (window.statsChartInstance) window.statsChartInstance.destroy();
                    const labels = sortedKeys.map(k => k.replace('modul', 'M-').toUpperCase());
                    const dataPoints = sortedKeys.map(k => Math.round(summaryStats[k].total / summaryStats[k].count));

                    window.statsChartInstance = new Chart(ctx, {
                        type: 'line', 
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Rata-Rata Nilai', data: dataPoints,
                                borderColor: '#004d00', backgroundColor: 'rgba(0, 77, 0, 0.2)', borderWidth: 3, tension: 0.3, fill: true, 
                                pointBackgroundColor: '#d4af37', pointBorderColor: '#004d00', pointRadius: 5
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                }, 100);

            } 
            // --- CABANG 4: UJIAN + HUKUM ---
            else {
                let targetModul = window.currentDatabaseId || 'modul1';
                if(statsTitle) statsTitle.innerText = "Data Modul: " + targetModul;
                thead.innerHTML = '<th>No</th><th>Tanggal</th><th>Nilai</th><th>Salah</th><th>Benar</th>';

                const currentModulHistory = allHistory.filter(h => h.modul === targetModul);
                
                tableBody.innerHTML = '';
                if (currentModulHistory.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">Belum ada data untuk modul ini.</td></tr>';
                } else {
                    [...currentModulHistory].reverse().forEach((d, idx) => {
                        tableBody.innerHTML += `
                            <tr>
                                <td>${idx+1}</td>
                                <td>${d.date}</td>
                                <td style="font-weight:bold; color:${d.score>=70?'green':'red'}">${d.score}</td>
                                <td>${d.wrong} ‚ùå</td>
                                <td>${d.correct} ‚úÖ</td>
                            </tr>`;
                    });
                }

                // Grafik Garis Ujian
                setTimeout(() => {
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    if (window.statsChartInstance) window.statsChartInstance.destroy();
                    window.statsChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: currentModulHistory.map((_, i) => "Tes " + (i+1)),
                            datasets: [{
                                label: 'Nilai Kamu', data: currentModulHistory.map(d => d.score),
                                borderColor: '#2980b9', backgroundColor: 'rgba(41, 128, 185, 0.2)', borderWidth: 2, tension: 0.3, fill: true
                            }, {
                                label: 'Batas Lulus (70)', data: currentModulHistory.map(() => 70),
                                borderColor: '#c0392b', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                }, 100);
            }

            // ========================================================
            // üî• INI BAGIAN PETA KEKUATAN (JANGAN DIHAPUS) üî•
            // Posisinya MASIH DI DALAM TRY, tapi DILUAR IF-ELSE LOBBY
            // ========================================================
            let modulStats = {};
            allHistory.forEach(h => {
                if(!modulStats[h.modul]) modulStats[h.modul] = { total: 0, count: 0 };
                modulStats[h.modul].total += parseInt(h.score);
                modulStats[h.modul].count++;
            });

            const sortedKeys = Object.keys(modulStats).sort((a, b) => {
                const numA = parseFloat(a.replace(/[^\d.]/g, '')) || 0;
                const numB = parseFloat(b.replace(/[^\d.]/g, '')) || 0;
                return numA - numB;
            });

            const labels = [];
            const dataScores = [];
            const backgroundColors = [];
            const colors = ['#e74c3c', '#3498db', '#9b59b6', '#f1c40f', '#2ecc71', '#e67e22', '#1abc9c'];

            sortedKeys.forEach((key, index) => {
                labels.push(key.replace('modul', 'M-').replace('btn-', ''));
                dataScores.push(Math.round(modulStats[key].total / modulStats[key].count));
                backgroundColors.push(colors[index % colors.length]);
            });

            setTimeout(() => {
                const ctxAll = document.getElementById('allModulesChart').getContext('2d');
                if (window.allModulesChartInstance) window.allModulesChartInstance.destroy();
                
                window.allModulesChartInstance = new Chart(ctxAll, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Rata-rata Nilai', data: dataScores, backgroundColor: backgroundColors, borderWidth: 1 }]
                    },
                    options: { 
                        animation: { duration: 1500, easing: 'easeOutBounce', y: { from: 0 } },
                        responsive: true, maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } } 
                    }
                });
            }, 100);
            // ========================================================

        } catch (e) { console.error("Error load data hukum:", e); }
    }
};
    
    window.closeStats = function() {
        document.getElementById('statsOverlay').style.display = 'none';
        const wm = document.getElementById('watermark');
        if(wm) wm.style.display = 'block';
    };

    function tampilkanLobby() {
        document.querySelector('.question-header').style.visibility = 'hidden';
        document.querySelector('.footer-nav').style.visibility = 'hidden';
        
        // --- UPDATE BARU: SWAP SIDEBAR ---
        // Sembunyikan Grid Ujian
        const examSide = document.getElementById('examSidebarContent');
        if(examSide) examSide.style.display = 'none';

        // Tampilkan Statistik Lobby
        const lobbySide = document.getElementById('lobbySidebarContent');
        if(lobbySide) lobbySide.style.display = 'flex'; 
        // ---------------------------------

        const qText = document.getElementById('questionText');
        qText.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üëà</div>
                <h3 style="color: #2c3e50; margin-bottom: 10px;">Siap Latihan?</h3>
                <p style="font-size: 1.2rem; color: #555;">
                    Silahkan <b>klik salah satu modul</b> di menu samping kiri<br>untuk memulai simulasi ujian.
                </p>
            </div>
        `;
        document.getElementById('optionsContainer').innerHTML = '';
        document.getElementById('feedbackBox').style.display = 'none';
        document.querySelectorAll('.modul-btn').forEach(el => el.classList.remove('active-modul'));
        
        // Reset Timer Tampilan
        document.getElementById('timerDisplay').innerText = "00:00:00";
    }

    // --- TAMBAHAN: LOAD DATA LOBBY ---
    setTimeout(() => { 
        if(window.loadLobbyData) window.loadLobbyData(); 
    }, 800); // Delay dikit biar smooth

    // ==========================================
    // LOGIKA ADMIN PANEL (INJECTED)
    // ==========================================

    window.openAdminPanel = () => {
        document.getElementById('adminOverlay').style.display = 'flex';
    };

    // UPDATE: Handler Tab Review
    window.switchAdminTab = (tab) => {
        document.getElementById('tabTambah').style.display = (tab === 'tambah' ? 'block' : 'none');
        document.getElementById('tabEdit').style.display = (tab === 'edit' ? 'block' : 'none');
        document.getElementById('tabReview').style.display = (tab === 'review' ? 'block' : 'none');
    };
    
// --- UPDATE 2: PERBAIKAN NOMOR SOAL (NaN FIX) ---
    window.loadReviewPembahasan = async () => {
        const modulId = document.getElementById('reviewModulTarget').value.trim();
        if(!modulId) return alert("Isi ID Modul!");
        
        const container = document.getElementById('containerReview');
        container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Sabar, lagi narik data...</div>`;
        
        try {
            const qSnap = await getDocs(collection(db, "bank_soal", modulId, "daftar_soal"));
            container.innerHTML = "";
            
            if (qSnap.empty) {
                container.innerHTML = "<p style='color:red; text-align:center;'>Modul tidak ditemukan atau kosong!</p>";
                return;
            }
            
            // PAKAI .docs.forEach SUPAYA INDEX (NOMOR) MUNCUL
            qSnap.docs.forEach((docSnap, index) => {
                const data = docSnap.data();
                const item = document.createElement('div');
                item.style = "margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;";
                
                // Cek apakah ada pembahasan, kalau kosong kasih strip
                const pembahasan = data.explanation ? data.explanation : "<em style='color:gray'>- Belum ada pembahasan -</em>";
                const sumber = data.cite ? data.cite : "-";

                item.innerHTML = `
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">Soal No. ${index + 1}</div>
                    <p style="margin-top:0;">${data.q}</p>
                    <div style="background:#f1f8e9; padding:15px; border-radius:8px; border-left:5px solid var(--success);">
                        <strong>üí° Pembahasan:</strong><br>
                        <div style="margin-top:5px; line-height:1.5;">${pembahasan}</div>
                        <div style="margin-top:10px; font-size:0.85rem; color:#666;">
                            <i class="fas fa-book"></i> Sumber: ${sumber}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        } catch(e) { 
            container.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
        }
    };
    
// --- FITUR 1: UPLOAD JSON (VERSI FIX PAPI KEYS) ---
    window.eksekusiUpload = async () => {
        const modulId = document.getElementById('adminModulTarget').value.trim();
        const jsonRaw = document.getElementById('jsonUploadArea').value;
        
        if(!modulId || !jsonRaw) return alert("Modul ID dan JSON harus diisi!");
        
        try {
            const dataSoal = JSON.parse(jsonRaw);
            if(!Array.isArray(dataSoal)) return alert("Format JSON harus Array [ ... ]");

            if(!confirm(`Siap upload ${dataSoal.length} soal ke ${modulId}?`)) return;

            const batch = writeBatch(db);
            let count = 0;
            let chunks = [];
            let currentBatch = writeBatch(db);
            
            // Loop data soal
            for (const item of dataSoal) {
                // Standarisasi field (JANGAN LUPA field papi_keys!)
                const docData = {
                    q: item.q || item.pertanyaan,
                    options: item.options || [item.opsiA, item.opsiB, item.opsiC, item.opsiD],
                    answer: item.answer !== undefined ? item.answer : parseInt(item.kunci), 
                    explanation: item.explanation || item.pembahasan || "-",
                    cite: item.cite || "Modul Hakim",
                    // --- INI BARIS PENTINGNYA ---
                    papi_keys: item.papi_keys || [], 
                    // ----------------------------
                    createdAt: new Date()
                };

                const newDocRef = doc(collection(db, "bank_soal", modulId, "daftar_soal"));
                currentBatch.set(newDocRef, docData);
                count++;

                // Batching limit Firestore (500 ops)
                if (count % 450 === 0) {
                    chunks.push(currentBatch);
                    currentBatch = writeBatch(db);
                }
            }
            
            if (count % 450 !== 0) chunks.push(currentBatch);
            
            // Eksekusi semua batch
            for (let b of chunks) await b.commit();
            
            alert(`‚úÖ Sukses Upload ${count} Soal (PAPI Keys Tersimpan)!`);
            document.getElementById('jsonUploadArea').value = ""; // Reset
            
        } catch (e) {
            alert("Error: " + e.message);
            console.error(e);
        }
    };

    // --- FITUR 2: LOAD & EDIT ---
    let currentAdminModul = "";

   // --- GANTI FUNGSI INI SAJA ---
    window.loadSoalAdmin = async () => {
        const modulId = document.getElementById('editModulTarget').value.trim();
        if(!modulId) return alert("Isi nama modul!");
        currentAdminModul = modulId;

        const listDiv = document.getElementById('listSoalAdmin');
        listDiv.innerHTML = "Loading... (Sedang mengambil data)";

        try {
            // Referensi ke collection
            const qRef = collection(db, "bank_soal", modulId, "daftar_soal");
            
            // REVISI: Hapus 'orderBy' biar data yang gak punya tanggal tetap muncul
            // const q = query(qRef, orderBy("createdAt", "desc")); <--- INI BIANG KEROKNYA
            
            // Kita pakai getDocs langsung ke qRef (ambil semua tanpa filter)
            const snapshot = await getDocs(qRef); 

            listDiv.innerHTML = "";
            
            if (snapshot.empty) {
                listDiv.innerHTML = "<p style='padding:10px; color:red'>Zonk! Modul kosong atau ID salah.</p>";
                return;
            }

            let counter = 0;
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const div = document.createElement('div');
                div.style.borderBottom = "1px solid #ddd";
                div.style.padding = "8px";
                div.style.cursor = "pointer";
                div.style.fontSize = "0.85rem";
                
                // Tampilkan sedikit teks pertanyaan biar gampang dikenali
                // Kita kasih fallback kalau 'q' kosong, cek 'pertanyaan'
                const teksSoal = data.q || data.pertanyaan || "(Soal Tanpa Teks)";
                div.innerText = `${++counter}. ${teksSoal.substring(0, 50)}...`;
                
                // Pas diklik, isi form di kanan
                div.onclick = () => populateEditForm(docSnap.id, data);
                listDiv.appendChild(div);
            });
            
        } catch (e) {
            console.error(e); // Cek Console (F12) kalau masih error
            alert("Gagal load: " + e.message + "\n\nTips: Cek apakah ID Modul persis sama (huruf besar/kecil)?");
        }
    };

    function populateEditForm(id, data) {
        document.getElementById('editDocId').value = id;
        document.getElementById('editQ').value = data.q;
        document.getElementById('editOpt').value = data.options.join(","); // Array jadi string koma
        document.getElementById('editAns').value = data.answer;
        document.getElementById('editExp').value = data.explanation;
        document.getElementById('editCite').value = data.cite || "";
    }

    window.simpanPerubahan = async () => {
        const id = document.getElementById('editDocId').value;
        if(!id) return alert("Pilih soal dulu!");

        const optionsArray = document.getElementById('editOpt').value.split(",").map(s => s.trim()); 

        const newData = {
            q: document.getElementById('editQ').value,
            options: optionsArray,
            answer: parseInt(document.getElementById('editAns').value),
            explanation: document.getElementById('editExp').value,
            cite: document.getElementById('editCite').value
        };

        try {
            const docRef = doc(db, "bank_soal", currentAdminModul, "daftar_soal", id);
            await updateDoc(docRef, newData);
            alert("‚úÖ Data terupdate!");
            loadSoalAdmin(); 
        } catch (e) {
            alert("Gagal update: " + e.message);
        }
    };

    window.hapusSoal = async () => {
        const id = document.getElementById('editDocId').value;
        if(!id) return alert("Pilih soal dulu!");
        if(!confirm("Yakin mau hapus soal ini permanen?")) return;

        try {
            const docRef = doc(db, "bank_soal", currentAdminModul, "daftar_soal", id);
            await deleteDoc(docRef);
            alert("üóëÔ∏è Soal dihapus.");
            loadSoalAdmin(); 
            document.getElementById('editDocId').value = "";
            document.getElementById('editQ').value = "";
        } catch (e) {
            alert("Gagal hapus: " + e.message);
        }
    };
        // ==========================================
        // LOGIKA TAHAP HAFALAN (MODUL 19.3)
        // ==========================================
        function showMemorizationPhase() {
            const overlay = document.createElement('div');
            overlay.id = "hafalanOverlay";
            overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000000; padding:20px; overflow-y:auto; text-align:center; font-family:'Poppins', sans-serif;";
            
            overlay.innerHTML = `
                <div style="max-width:800px; margin: 20px auto; background:#fff; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); border-top:8px solid var(--primary);">
                    <h2 style="color:var(--primary); margin-bottom:10px;">üß† TAHAP HAFALAN</h2>
                    <p style="color:#666;">Hafalkan data di bawah ini dalam waktu <b>3 menit</b>!</p>
                    <hr style="border:1px solid #eee; margin:15px 0;">
                    
                    <div style="background:#f9f9f9; padding:20px; border-radius:10px; display:grid; grid-template-columns: 1fr; text-align:left; font-family:monospace; border:2px solid #ddd; line-height:1.8; font-size:1rem; width:100%; box-sizing:border-box;">
                        <b>BUNGA:</b> Dahlia, Flamboyan, Laret, Soka, Yasmin<br>
                        <b>PERKAKAS:</b> Cangkul, Jarum, Kikir, Palu, Wajan<br>
                        <b>BURUNG:</b> Elang, Itik, Tekukur, Nuri, Walet<br>
                        <b>KESENIAN:</b> Arca, Gamelan, Opera, Quintet, Ukiran<br>
                        <b>BINATANG:</b> Beruang, Harimau, Rusa, Zebra, Musang
                    </div>
        
                    <div id="countdownHafalan" style="font-size:3rem; font-weight:800; color:var(--danger); margin:30px 0;">03:00</div>
                    
                    <button id="btnSkipHafalan" style="background:var(--success); color:white; border:none; padding:15px 30px; border-radius:8px; cursor:pointer; font-weight:bold; width:100%; font-size:1rem;">
                        SAYA SUDAH HAFAL (MULAI TES)
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        
            let timeLeft = 180; 
            const timerText = document.getElementById('countdownHafalan');
            
            window.hafalanCountdown = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerText.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                if (timeLeft <= 0) stopHafalanAndStartQuiz();
            }, 1000);
        
            document.getElementById('btnSkipHafalan').onclick = () => {
                if(confirm("Yakin sudah hafal? Data tidak bisa dilihat kembali saat ujian.")) {
                    stopHafalanAndStartQuiz();
                }
            };
        }
        
        function stopHafalanAndStartQuiz() {
            clearInterval(window.hafalanCountdown);
            const overlay = document.getElementById('hafalanOverlay');
            if(overlay) overlay.remove();
            
            loadQuestion(0);
            startTimer();
        }

        window.switchCategory = function(cat) {
        const groupHukum = document.getElementById('group-hukum');
        const groupPsikotes = document.getElementById('group-psikotes');
        const btnHukum = document.getElementById('btnTabHukum');
        const btnPsikotes = document.getElementById('btnTabPsikotes');

    if (cat === 'hukum') {
        groupHukum.style.display = 'block';
        groupPsikotes.style.display = 'none';
        // Styling Button
        btnHukum.style.background = 'var(--primary)';
        btnHukum.style.color = 'white';
        btnPsikotes.style.background = '#ccc';
        btnPsikotes.style.color = '#333';
    } else {
        groupHukum.style.display = 'none';
        groupPsikotes.style.display = 'block';
        // Styling Button
        btnPsikotes.style.background = '#8e44ad'; // Warna ungu biar beda
        btnPsikotes.style.color = 'white';
        btnHukum.style.background = '#ccc';
        btnHukum.style.color = '#333';
    }
}
// --- FUNGSI LOAD DATA DASHBOARD (FIXED: HILANGKAN TOMBOL GANDA) ---
    window.loadLobbyData = async () => {
        const user = auth.currentUser;
        if (!user || !db) return;

        // 1. RATA-RATA (GRAFIK DONUT)
        try {
            const qHistory = query(collection(db, "riwayat_belajar"), where("uid", "==", user.uid));
            const snapHistory = await getDocs(qHistory);
            let bestScoresMap = {}; 
            
            snapHistory.forEach(doc => {
                const d = doc.data();
                const nilai = parseInt(d.score) || 0; 
                if (!bestScoresMap[d.modul] || nilai > bestScoresMap[d.modul]) {
                    bestScoresMap[d.modul] = nilai;
                }
            });
            const modulesTaken = Object.values(bestScoresMap);
            let avg = 0;
            if (modulesTaken.length > 0) {
                const totalBest = modulesTaken.reduce((a, b) => a + b, 0);
                avg = Math.round(totalBest / modulesTaken.length);
            }
            const txtAvg = document.getElementById('avgScoreText');
            if(txtAvg) txtAvg.innerText = avg;
            const ctx = document.getElementById('lobbyMiniChart');
            if (ctx) {
                if (window.lobbyChartInstance) window.lobbyChartInstance.destroy();
                window.lobbyChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pencapaian', 'Gap'],
                        datasets: [{
                            data: [avg, 100 - avg],
                            backgroundColor: [avg >= 70 ? '#2e7d32' : '#f39c12', '#eeeeee'], 
                            borderWidth: 0,
                            cutout: '75%'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        animation: { animateScale: true, animateRotate: true }
                    }
                });
            }
        } catch (e) { console.error("Err History:", e); }

        // 2. TOP 3 GLOBAL (SIDEBAR)
        try {
            const qLb = query(collection(db, "leaderboard"), orderBy("skor", "desc"), limit(500));
            const snapLb = await getDocs(qLb);
            let userTotals = {}; 
            snapLb.forEach(doc => {
                const d = doc.data();
                const nilai = parseInt(d.skor) || 0; 
                if (!userTotals[d.nama]) userTotals[d.nama] = {};
                if (!userTotals[d.nama][d.modul] || nilai > userTotals[d.nama][d.modul]) {
                    userTotals[d.nama][d.modul] = nilai;
                }
            });
            let rankingList = [];
            for (let [nama, modules] of Object.entries(userTotals)) {
                const totalPoints = Object.values(modules).reduce((a, b) => a + b, 0);
                rankingList.push({ nama: nama, total: totalPoints });
            }
            rankingList.sort((a, b) => b.total - a.total);

            const lbContainer = document.getElementById('miniLeaderboardList');
            if (lbContainer) {
                if (rankingList.length === 0) {
                    lbContainer.innerHTML = '<small style="color:#999;">Belum ada data.</small>';
                } else {
                    let html = '';
                    rankingList.slice(0, 3).forEach((u, i) => {
                        let medal = i===0 ? 'ü•á' : (i===1 ? 'ü•à' : 'ü•â');
                        html += `<div class="mini-rank-item"><span class="rank-num">${medal}</span><span class="rank-name">${u.nama}</span><span class="rank-score">${u.total} Pts</span></div>`;
                    });
                    lbContainer.innerHTML = html;
                    
                    // --- BAGIAN INI DIHAPUS BIAR TOMBOL GAK DOBEL ---
                    // const btnMore = document.createElement('button'); ... (DIBUANG)
                }
            }
        } catch (e) { console.error("Err Leaderboard:", e); }
    };
    
</script>

<script>
    // 1. Matikan Klik Kanan
    document.addEventListener('contextmenu', event => {
        if (document.body.classList.contains('is-admin')) return; // ADMIN BEBAS
        event.preventDefault();
    });

    // 2. Matikan Blok/Select Teks
    document.addEventListener('selectstart', event => {
        if (document.body.classList.contains('is-admin')) return; // ADMIN BEBAS
        event.preventDefault();
    });
    
    document.addEventListener('dragstart', event => {
        if (document.body.classList.contains('is-admin')) return; // ADMIN BEBAS
        event.preventDefault();
    });

    // 3. Matikan Shortcut Keyboard
    document.addEventListener('keydown', function(e) {
        if (document.body.classList.contains('is-admin')) return; // ADMIN BEBAS

        // Cegah F12, Inspect, Copy Paste
        if (
            e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') || 
            (e.ctrlKey && e.shiftKey && e.key === 'J') || 
            (e.ctrlKey && e.key === 'u') || 
            (e.ctrlKey && e.key === 'U') || 
            (e.ctrlKey && e.key === 's') || 
            (e.ctrlKey && e.key === 'p') || 
            (e.ctrlKey && e.key === 'a') || 
            (e.ctrlKey && e.key === 'c')
        ) {
            e.preventDefault();
            e.stopPropagation();
            alert("‚ö†Ô∏è Eits! Fitur ini dikunci demi keamanan ujian.");
            return false;
        }
    });
    window.bukaDetailPapi = async (docId) => {
    try {
        if (!window.db) return alert("Error: Database belum siap!");
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const docRef = doc(window.db, "riwayat_psikotes", docId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const d = docSnap.data();
            let dataObj = typeof d.detail_skor === 'string' ? JSON.parse(d.detail_skor) : d.detail_skor;
            
            // üî• LOGIKA SAKTI: Cek apakah format baru atau lama
            const scores = dataObj.scores ? dataObj.scores : dataObj; 
            const mapping = dataObj.mapping || {};

            const strategi = {
            // --- KELOMPOK UTAMAKAN (WAJIB TINGGI: 6-9)  ---
            'R': { label: "Role Consistency (Rasional)", target: "6-9", saran: "Pertahankan cara berpikir berbasis fakta dan aturan." },
            'D': { label: "Decision Making (Tegas)", target: "6-9", saran: "Bagus, hakim harus berani mengambil keputusan hukum." },
            'E': { label: "Emotional Restraint (Tenang)", target: "6-9", saran: "Stabilitas emosi adalah kunci kematangan hakim." },
            'M': { label: "Mental Activity (Waspada)", target: "6-9", saran: "Tetap waspada dan teliti dalam membedah perkara." },
            'B': { label: "Belonging to Group (Perseverance)", target: "6-9", saran: "Ketekunan dalam bekerja secara sistematis." },
            'N': { label: "Need to Finish (Tuntas)", target: "6-9", saran: "Selesaikan perkara tepat waktu, jangan ditunda." },
            'C': { label: "Conformity (Teratur/Rapi)", target: "6-9", saran: "Kerapian berkas mencerminkan kerapian logika putusan." },
            'A': { label: "Attention to Detail (Teliti)", target: "6-9", saran: "Ketelitian mencegah putusan yang rawan cacat." },
            'Z': { label: "Need for Change (Adaptif)", target: "6-9", saran: "Adaptif pada aturan baru, tapi tidak eksperimental." },
            'W': { label: "Need for Rules (Patuh Etik)", target: "7-9", saran: "Wajib patuh pada Kode Etik dan Pedoman Perilaku Hakim." },
        
            // --- KELOMPOK MODERAT (SEDANG: 4-6)  ---
            'L': { label: "Leadership (Kepemimpinan)", target: "4-6", saran: "Pimpin persidangan secara fungsional, bukan dominan." },
            'T': { label: "Pace (Kecepatan)", target: "4-6", saran: "Bekerja dengan ritme stabil, utamakan ketelitian." },
            'V': { label: "Vigor (Energi Vitalitas)", target: "4-6", saran: "Jaga stamina kerja untuk menghadapi sidang yang panjang." },
            'P': { label: "Control Others (Mengatur)", target: "4-6", saran: "Atur jalannya sidang sesuai hukum acara." },
        
            // --- KELOMPOK HINDARI (RENDAH: 0-4)  ---
            'X': { label: "Need to be Noticed (Populer)", target: "0-4", saran: "Hakim bekerja untuk keadilan, bukan untuk panggung." },
            'S': { label: "Social Extension (Bergaul)", target: "0-4", saran: "Batasi pergaulan untuk menjaga independensi hakim." },
            'I': { label: "Theoretical Type (Inisiatif)", target: "0-4", saran: "Patuhi hukum positif, jangan membuat eksperimen hukum." },
            'G': { label: "Hard Intense Worker (Ambisi)", target: "0-4", saran: "Hindari ambisi berlebihan yang merusak objektivitas." },
            'K': { label: "Aggression (Emosional/Agresif)", target: "0-3", saran: "Hindari sikap defensif atau mudah marah di persidangan." },
            'O': { label: "Need for Closeness (Kedekatan)", target: "0-4", saran: "Jangan terlalu bergantung pada instruksi orang lain." }
        };

            let report = `‚öñÔ∏è ANALISIS PROFIL\n${"=".repeat(35)}\n\n`;

            // Ambil semua elemen yang ada skornya
            const keys = Object.keys(scores);
            if (keys.length === 0) report += "Data skor tidak ditemukan.";

            keys.forEach(el => {
                const info = strategi[el] || { label: "Elemen Pendukung", target: "-", saran: "Jaga keseimbangan profil." };
                const score = scores[el];
                const soalList = mapping[el] ? mapping[el].join(", ") : "Tersedia di tes berikutnya";
                
                let evalMsg = "‚ö†Ô∏è CEK";
                if (strategi[el]) {
                    const range = info.target.match(/\d+/g);
                    const min = parseInt(range[0]);
                    const max = parseInt(range[1] || range[0]);
                    evalMsg = (score >= min && score <= max) ? "‚úÖ IDEAL" : "‚ùå EVALUASI";
                }

                report += `‚óè [${el}] ${info.label}: ${score}\n`;
                report += `  Status: ${evalMsg} (Target: ${info.target})\n`;
                if(mapping[el]) report += `  Nomor Soal: ${soalList}\n`;
                report += `  Saran: ${info.saran}\n\n`;
            });

            alert(report);
        } // Menutup if (docSnap.exists())
    } // <--- TAMBAHAN: Menutup try
    catch (e) {
        alert("Gagal membedah data: " + e.message);
    }
};
</script>

</body>
</html>




